<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="记录自己对相关技术的点点滴滴和一些思考，希望能够帮助来到这里的你，如果你喜欢我的文章，可以加个微信共同探讨">
<meta name="keywords" content="eos,eth,tron,区块链">
<meta property="og:type" content="website">
<meta property="og:title" content="hello shaokun">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="hello shaokun">
<meta property="og:description" content="记录自己对相关技术的点点滴滴和一些思考，希望能够帮助来到这里的你，如果你喜欢我的文章，可以加个微信共同探讨">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hello shaokun">
<meta name="twitter:description" content="记录自己对相关技术的点点滴滴和一些思考，希望能够帮助来到这里的你，如果你喜欢我的文章，可以加个微信共同探讨">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>hello shaokun</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hello shaokun</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">code is law</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/15/graphql构建服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/15/graphql构建服务/" itemprop="url">koa + graphql的使用(2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-15T22:35:14+08:00">
                2020-11-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><blockquote>
<p><a href="https://shaokun11.github.io/2020/08/16/koa+graphql%E5%AE%9A%E4%B9%89%E4%BD%A0%E7%9A%84%E6%8E%A5%E5%8F%A3/" target="_blank" rel="noopener">koa + graphql的使用</a>在这篇文章中,我们只实现了基本上的如何使用graphql,那么我们来实现业务上的graphql</p>
</blockquote>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><ul>
<li>目录结构,大体上分为三个目录结构,schema用于定于所有的类型,resolver定义相应类型的实现,models定义一些service的具体实现,如查询数据库,app.ts为项目入口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./src:</span><br><span class="line">app.ts		models		resolvers	schema</span><br><span class="line"></span><br><span class="line">./src/models:</span><br><span class="line">index.ts</span><br><span class="line"></span><br><span class="line">./src/resolvers:</span><br><span class="line">index.ts	message.ts	user.ts</span><br><span class="line"></span><br><span class="line">./src/schema:</span><br><span class="line">index.ts	message.ts	user.ts</span><br></pre></td></tr></table></figure>
<ul>
<li>项目入口app.ts,可以看到和上诉定义的目录结构一致,引入根数据,注意其中的context,这里用于挂在挂载全局变量,实现一些中间件的挂载,如auth</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Koa <span class="keyword">from</span> <span class="string">"koa"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApolloServer &#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line"><span class="keyword">import</span> resolvers <span class="keyword">from</span> <span class="string">"./resolvers"</span>;</span><br><span class="line"><span class="keyword">import</span> typeDefs <span class="keyword">from</span> <span class="string">"./schema"</span>;</span><br><span class="line"><span class="keyword">import</span> models <span class="keyword">from</span> <span class="string">"./models"</span>;</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context: &#123;</span><br><span class="line">    models,</span><br><span class="line">    me: models.users[<span class="number">1</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: <span class="number">5000</span> &#125;, () =&gt;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`🚀 Server ready at http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ul>
<li>定义user的schema,注意其中的query加上了extend字段(message.ts内容一致)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;gql&#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = gql<span class="string">`</span></span><br><span class="line"><span class="string">    extend type Query &#123;</span></span><br><span class="line"><span class="string">        users: [User!]</span></span><br><span class="line"><span class="string">        user(id: ID!): User</span></span><br><span class="line"><span class="string">        me: String!</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    type User &#123;</span></span><br><span class="line"><span class="string">        id: ID!</span></span><br><span class="line"><span class="string">        username: String!</span></span><br><span class="line"><span class="string">        messages: [Message!]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> User;</span><br><span class="line"><span class="string">``</span><span class="string">`   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-	定义schema的导出文件,定义空的schema,以便具体的实体可以继承,固定写法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascritp</span><br><span class="line">	<span class="keyword">import</span> &#123; gql &#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line">	<span class="keyword">import</span> message <span class="keyword">from</span> <span class="string">"./message"</span>;</span><br><span class="line">	<span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">"./user"</span>;</span><br><span class="line">	<span class="keyword">const</span> linkSchema = gql<span class="string">`</span></span><br><span class="line"><span class="string">	  type Query &#123;</span></span><br><span class="line"><span class="string">	    _: Boolean</span></span><br><span class="line"><span class="string">	  &#125;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	  type Mutation &#123;</span></span><br><span class="line"><span class="string">	    _: Boolean</span></span><br><span class="line"><span class="string">	  &#125;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	  type Subscription &#123;</span></span><br><span class="line"><span class="string">	    _: Boolean</span></span><br><span class="line"><span class="string">	  &#125;</span></span><br><span class="line"><span class="string">	`</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">export</span> <span class="keyword">default</span> [linkSchema, user, message];</span><br></pre></td></tr></table></figure>
<ul>
<li>user的resolver具体实现,根据user的schema实现,这里注意resolver接收四个参数,根据官网的说法,我们一般用上前三个就够了,</li>
</ul>
<ul>
<li>分别是parent,即上一个查询的的结果</li>
<li>args,本次执行的前端页面传过来的参数</li>
<li>context,即app中的context,即返回的那个object</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;IResolvers&#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user: IResolvers = &#123;</span><br><span class="line">	Query: &#123;</span><br><span class="line">		users: <span class="function">(<span class="params">parent, args, &#123;models&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">Object</span>.values(models.users);</span><br><span class="line">		&#125;,</span><br><span class="line">		user: <span class="function">(<span class="params">parent, &#123;id&#125;, &#123;models&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> models.users[id];</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">	User: &#123;</span><br><span class="line">		messages: <span class="function">(<span class="params">user, args, &#123;models&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">Object</span>.values(models.messages).filter(</span><br><span class="line">				<span class="comment">//@ts-ignore</span></span><br><span class="line">				(message) =&gt; message.userId === user.id</span><br><span class="line">			);</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> user;</span><br></pre></td></tr></table></figure>
<ul>
<li>resolver 导出文件,直接导出数组即可  </li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> message <span class="keyword">from</span> <span class="string">"./message"</span>;</span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">"./user"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [message, user];</span><br></pre></td></tr></table></figure>
<ul>
<li>models 模拟本次程序的数据,现实中用数据库代替即可</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> users = &#123;</span><br><span class="line">  <span class="number">1</span>: &#123;</span><br><span class="line">    id: <span class="string">"1"</span>,</span><br><span class="line">    username: <span class="string">"hello shoakun 1"</span>,</span><br><span class="line">    messageIds: [<span class="number">1</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">2</span>: &#123;</span><br><span class="line">    id: <span class="string">"2"</span>,</span><br><span class="line">    username: <span class="string">"hello shaokun2"</span>,</span><br><span class="line">    messageIds: [<span class="number">2</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> messages = &#123;</span><br><span class="line">  <span class="number">1</span>: &#123;</span><br><span class="line">    id: <span class="string">"1"</span>,</span><br><span class="line">    text: <span class="string">"Hello World"</span>,</span><br><span class="line">    userId: <span class="string">"1"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">2</span>: &#123;</span><br><span class="line">    id: <span class="string">"2"</span>,</span><br><span class="line">    text: <span class="string">"By World"</span>,</span><br><span class="line">    userId: <span class="string">"2"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  users,</span><br><span class="line">  messages,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="结果演示"><a href="#结果演示" class="headerlink" title="结果演示"></a>结果演示</h5><p><a href="https://github.com/shaokun11/gql-server" target="_blank" rel="noopener">源码</a><br><img src="/react/graphql2.gif" alt="graphql query demo"> </p>
<h5 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h5><p>区块链技术痴迷的程序猿一枚，如果你喜欢我的文章，可以加上微信共同学习，共同进步。  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/08/uniswap 源码解读6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/08/uniswap 源码解读6/" itemprop="url">一步一步教你打造自己的defi-xswap(6)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-08T17:10:49+08:00">
                2020-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>本篇文章主要配合前端实现xswap的最后一个功能swap</p>
</blockquote>
<h4 id="swap公式"><a href="#swap公式" class="headerlink" title="swap公式"></a>swap公式</h4><ul>
<li>此公式由 UniswapV2Library提供</li>
<li>getAmountOut 即我付出一定量的token,可以得到另一种token的多少,比如我只有100个tokenA,这个就是查看我这个100tokenA可以换取到多少个tokenB</li>
<li>getAmountIn, 即我要得到一定量的token,我得付出多少另一种token,比如我想要100个tokenA,那么这个就是查看我要付出多少个tokenB</li>
<li>每次交易,均有千分之三fromToken的损失,这部分费用是按照LP的比例分给提供LP的做市商</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAmountOut</span>(<span class="params">uint amountIn, uint reserveIn, uint reserveOut</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint amountOut</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">require</span>(amountIn &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT'</span>);</span><br><span class="line">      <span class="built_in">require</span>(reserveIn &gt; <span class="number">0</span> &amp;&amp; reserveOut &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_LIQUIDITY'</span>);</span><br><span class="line">      uint amountInWithFee = amountIn.mul(<span class="number">997</span>);</span><br><span class="line">      uint numerator = amountInWithFee.mul(reserveOut);</span><br><span class="line">      uint denominator = reserveIn.mul(<span class="number">1000</span>).add(amountInWithFee);</span><br><span class="line">      amountOut = numerator / denominator;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// given an output amount of an asset and pair reserves, returns a required input amount of the other asset</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAmountIn</span>(<span class="params">uint amountOut, uint reserveIn, uint reserveOut</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint amountIn</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">require</span>(amountOut &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_OUTPUT_AMOUNT'</span>);</span><br><span class="line">      <span class="built_in">require</span>(reserveIn &gt; <span class="number">0</span> &amp;&amp; reserveOut &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_LIQUIDITY'</span>);</span><br><span class="line">      uint numerator = reserveIn.mul(amountOut).mul(<span class="number">1000</span>);</span><br><span class="line">      uint denominator = reserveOut.sub(amountOut).mul(<span class="number">997</span>);</span><br><span class="line">      amountIn = (numerator / denominator).add(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="demo验证"><a href="#demo验证" class="headerlink" title="demo验证"></a>demo验证</h4><ul>
<li><a href="https://github.com/shaokun11/xswap/tree/v4" target="_blank" rel="noopener">本次演示前端代码</a></li>
<li>目前有两步操作,一是转入tokenA到pair中,二是根据上述的算法,动态计算出tokenA转入可以得到的tokenB的数量,调用pair的swap方法将tokenB提到自己的钱包中</li>
<li>前端需使用bignumber.js这个lib来计算大数,可以看到和合约的实现是一样的,只有这样才能通过验证  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import BN from &apos;bignumber.js&apos;</span><br><span class="line">function getAmountIn(amountOut: string, reserveIn: string, reserveOut) &#123;</span><br><span class="line">    return new BN(&apos;1000&apos;)</span><br><span class="line">        .times(amountOut)</span><br><span class="line">        .times(reserveIn)</span><br><span class="line">        .div(new BN(reserveOut).minus(amountOut).times(997).plus(1))</span><br><span class="line">        .toFixed()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getAmountOut(amountIn: string, reserveIn: string, reserveOut: string) &#123;</span><br><span class="line">    let feeIn = new BN(amountIn).times(997)</span><br><span class="line">    return feeIn</span><br><span class="line">        .times(reserveOut)</span><br><span class="line">        .div(feeIn.plus(new BN(1000).times(reserveIn)))</span><br><span class="line">        .toFixed()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/xswap/ether7.gif" alt="xswap">  </p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>xswap到这里已经结束了.</li>
<li>本系列只重点着重于合约代码层面的实现,采用react全家桶实现的前端界面(文中做过多介绍前端代码的实现).</li>
<li>个人觉得uniswap的精髓在其整个的设计与其创新,理论上来讲,是真正实现了一个去中心化的交易所的功能</li>
<li>目前前端页面只提供了tokenA,与tokenB的操作,且只适用于rinkeby网络,如果各位同学想要进一步发挥,可以完全参考uniswap的实现<a href="https://github.com/Uniswap/uniswap-v2-periphery" target="_blank" rel="noopener">uniswap-peripher</a>,<a href="https://github.com/Uniswap/uniswap-interface" target="_blank" rel="noopener">uniswap前端页面</a>自己实现一套属于自己的swap吧</li>
</ul>
<h4 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h4><p>区块链程序猿一枚<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/07/uniswap 源码解读5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/07/uniswap 源码解读5/" itemprop="url">一步一步教你打造自己的defi-xswap(5)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-07T19:05:23+08:00">
                2020-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>本篇文章主要介绍UniswapV2Pair中的以及一个名词,三个方法,四个变量,理解完后,实现xswap的add,remove的功能</p>
</blockquote>
<h4 id="一个名词"><a href="#一个名词" class="headerlink" title="一个名词"></a>一个名词</h4><ul>
<li>liquidity (LP)流动性,即pair的token的数量,代表着你所有这个pair价值的量,其价值为你的LP占总LP的百分比乘以pair的总价值</li>
</ul>
<h4 id="四个变量"><a href="#四个变量" class="headerlink" title="四个变量"></a>四个变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">address public token0;			//	交易对中的token0 的地址</span><br><span class="line">address public token1;			// 交易对中的token1 的地址</span><br><span class="line">uint112 private reserve0;    // 交易对地址中的 token0的数量,即token0的价值    </span><br><span class="line">uint112 private reserve1; 	// 交易对地址中的 token1的数量 ,即token1的价值</span><br></pre></td></tr></table></figure>
<h4 id="三个方法"><a href="#三个方法" class="headerlink" title="三个方法"></a>三个方法</h4><ul>
<li>mint 即生产LP,其规则根据你向这个pair中按照<strong>固定比例(第一笔设定比例)</strong>转入一定数量token0,token1.当然你可以不按照这个比例转入,但是你得到的LP是按照这个比例中的小的给你算的,所以不要做这样的事呢</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function mint(address to) external lock returns (uint liquidity) &#123;</span><br><span class="line">    (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">    uint balance0 = IERC20(token0).balanceOf(address(this));</span><br><span class="line">    uint balance1 = IERC20(token1).balanceOf(address(this));</span><br><span class="line">    uint amount0 = balance0.sub(_reserve0);</span><br><span class="line">    uint amount1 = balance1.sub(_reserve1);</span><br><span class="line">    bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">    uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">    if (_totalSupply == 0) &#123;</span><br><span class="line">        liquidity = Math.sqrt(amount0.mul(amount1)).sub(MINIMUM_LIQUIDITY);</span><br><span class="line">       _mint(address(0), MINIMUM_LIQUIDITY); // permanently lock the first MINIMUM_LIQUIDITY tokens</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        liquidity = Math.min(amount0.mul(_totalSupply) / _reserve0, amount1.mul(_totalSupply) / _reserve1);</span><br><span class="line">    &#125;</span><br><span class="line">    require(liquidity &gt; 0, &apos;UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED&apos;);</span><br><span class="line">    _mint(to, liquidity);</span><br><span class="line"></span><br><span class="line">    _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">    if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">    emit Mint(msg.sender, amount0, amount1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>burn 即销毁你转入的LP,即你先把LP转入pair合约中,然后根据你转入的LP数量按照占总量LP的比例返回pair中token0,token1到你指定的地址</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">burn</span>(<span class="params">address to</span>) <span class="title">external</span> <span class="title">lock</span> <span class="title">returns</span> (<span class="params">uint amount0, uint amount1</span>) </span>&#123;</span><br><span class="line">      (uint112 _reserve0, uint112 _reserve1,) = getReserves(); <span class="comment">// gas savings</span></span><br><span class="line">      address _token0 = token0;                                <span class="comment">// gas savings</span></span><br><span class="line">      address _token1 = token1;                                <span class="comment">// gas savings</span></span><br><span class="line">      uint balance0 = IERC20(_token0).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">      uint balance1 = IERC20(_token1).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">      uint liquidity = balanceOf[address(<span class="keyword">this</span>)];</span><br><span class="line">      bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">      uint _totalSupply = totalSupply; <span class="comment">// gas savings, must be defined here since totalSupply can update in _mintFee</span></span><br><span class="line">      amount0 = liquidity.mul(balance0) / _totalSupply; <span class="comment">// using balances ensures pro-rata distribution</span></span><br><span class="line">      amount1 = liquidity.mul(balance1) / _totalSupply; <span class="comment">// using balances ensures pro-rata distribution</span></span><br><span class="line">      <span class="built_in">require</span>(amount0 &gt; <span class="number">0</span> &amp;&amp; amount1 &gt; <span class="number">0</span>, <span class="string">'UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED'</span>);</span><br><span class="line">      _burn(address(<span class="keyword">this</span>), liquidity);</span><br><span class="line">      _safeTransfer(_token0, to, amount0);</span><br><span class="line">      _safeTransfer(_token1, to, amount1);</span><br><span class="line">      balance0 = IERC20(_token0).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">      balance1 = IERC20(_token1).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">      _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">      <span class="keyword">if</span> (feeOn) kLast = uint(reserve0).mul(reserve1); <span class="comment">// reserve0 and reserve1 are up-to-date</span></span><br><span class="line">      emit Burn(msg.sender, amount0, amount1, to);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>swap 即使用token0交换token1或者相反交易.注意一下,swap是不会改变pair的LP的量.这个呢会改变当前两种token对应的价格.所以一个token的价格也即是通过这种方式来定义的呢!</p>
</li>
<li>这里具体的操作呢?这里设计得非常巧妙!</li>
<li><em>function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external lock </em> 函数签名中,amount0Out与amount1Out一定有一个值为0,所以首先得转入你需要交易的卖掉的token,如果是token0,那么调用此方法的第二个参数即amount1Out设置为大于0的值即可得到你想要的另一种token,即完成了一次交易,至于这个值填多少? 值为理论转出的99.7%</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">swap</span>(<span class="params">uint amount0Out, uint amount1Out, address to, bytes calldata data</span>) <span class="title">external</span> <span class="title">lock</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(amount0Out &gt; <span class="number">0</span> || amount1Out &gt; <span class="number">0</span>, <span class="string">'UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT'</span>);</span><br><span class="line">    (uint112 _reserve0, uint112 _reserve1,) = getReserves(); <span class="comment">// gas savings</span></span><br><span class="line">    <span class="built_in">require</span>(amount0Out &lt; _reserve0 &amp;&amp; amount1Out &lt; _reserve1, <span class="string">'UniswapV2: INSUFFICIENT_LIQUIDITY'</span>);</span><br><span class="line"></span><br><span class="line">    uint balance0;</span><br><span class="line">    uint balance1;</span><br><span class="line">    &#123; <span class="comment">// scope for _token&#123;0,1&#125;, avoids stack too deep errors</span></span><br><span class="line">    address _token0 = token0;</span><br><span class="line">    address _token1 = token1;</span><br><span class="line">    <span class="built_in">require</span>(to != _token0 &amp;&amp; to != _token1, <span class="string">'UniswapV2: INVALID_TO'</span>);</span><br><span class="line">    <span class="keyword">if</span> (amount0Out &gt; <span class="number">0</span>) _safeTransfer(_token0, to, amount0Out); <span class="comment">// optimistically transfer tokens</span></span><br><span class="line">    <span class="keyword">if</span> (amount1Out &gt; <span class="number">0</span>) _safeTransfer(_token1, to, amount1Out); <span class="comment">// optimistically transfer tokens</span></span><br><span class="line">    <span class="keyword">if</span> (data.length &gt; <span class="number">0</span>) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);</span><br><span class="line">    balance0 = IERC20(_token0).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">    balance1 = IERC20(_token1).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    uint amount0In = balance0 &gt; _reserve0 - amount0Out ? balance0 - (_reserve0 - amount0Out) : <span class="number">0</span>;</span><br><span class="line">    uint amount1In = balance1 &gt; _reserve1 - amount1Out ? balance1 - (_reserve1 - amount1Out) : <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">require</span>(amount0In &gt; <span class="number">0</span> || amount1In &gt; <span class="number">0</span>, <span class="string">'UniswapV2: INSUFFICIENT_INPUT_AMOUNT'</span>);</span><br><span class="line">    &#123; <span class="comment">// scope for reserve&#123;0,1&#125;Adjusted, avoids stack too deep errors</span></span><br><span class="line">    uint balance0Adjusted = balance0.mul(<span class="number">1000</span>).sub(amount0In.mul(<span class="number">3</span>));</span><br><span class="line">    uint balance1Adjusted = balance1.mul(<span class="number">1000</span>).sub(amount1In.mul(<span class="number">3</span>));</span><br><span class="line">    <span class="built_in">require</span>(balance0Adjusted.mul(balance1Adjusted) &gt;= uint(_reserve0).mul(_reserve1).mul(<span class="number">1000</span>**<span class="number">2</span>), <span class="string">'UniswapV2: K'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">    emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="demo验证"><a href="#demo验证" class="headerlink" title="demo验证"></a>demo验证</h4><ul>
<li><a href="https://github.com/shaokun11/xswap/tree/v3" target="_blank" rel="noopener">本次演示前端代码</a></li>
<li>相关合约地址: factory:<strong>0xfed46C22C2C39126F3312fBe739a0D9cD29AD1D1</strong> tokenA: <strong>0x425CBf6caF564FfFe1629ACADBD17Ee421B1f6aE</strong> tokenB: <strong>0x7A759B6cb32Ba3098530909aD5178dc6125A2c26</strong></li>
<li>由于执行添加或者swap需要一对token,所以顺带创建了2个测试token,<a href="https://github.com/shaokun11/solidity-env-hardhat/blob/v4/contracts/XToken.sol" target="_blank" rel="noopener">xtoken模板</a>提供了<em>faucet</em>方法,每次调用将会空投100个token到操作账户的地址</li>
<li>这里我初始定价为 2 tokenA = 1 tokenB,</li>
<li>使用faucet方法分别得到一定数量的tokenA tokenB(这里只演示了获取TokenA)</li>
<li>add 转账tokenA 都pair合约中,转账tokenB到pair合约中,换取LP到自己的账户 (这里一共执行了三次合约)</li>
<li>remove 转账LP到pair合约中,再根据转进去的LP按照总的比例取出换回来的tokenA,tokenB<br><img src="/xswap/ether5.gif" alt="xswap">  </li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>注意一下,本系列所有的合约仅部署在了rinkeby测试链上,如果需要源码演示请切换网络才</li>
<li>此合约部署只需要<a href="https://github.com/Uniswap/uniswap-v2-core/blob/master/contracts/UniswapV2Factory.sol" target="_blank" rel="noopener">UniswapV2Factory.sol</a>这一个合约即可,这里我flatten一下这个合约,各位同学可以直接使用<a href="https://github.com/shaokun11/solidity-env-hardhat/blob/v4/contracts/XSwapFactory.sol" target="_blank" rel="noopener">faltten UniswapV2Factory.sol</a></li>
<li>看完pari这个合约,合约代码方面的技术难题了,本篇文章只实现了add的功能,下一篇实现其最后一个功能swap</li>
</ul>
<h4 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h4><p>区块链程序猿一枚<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/02/uniswap 源码解读4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/02/uniswap 源码解读4/" itemprop="url">一步一步教你打造自己的defi-xswap(4)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-02T23:17:23+08:00">
                2020-11-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>本篇文章编写智能合约中的create2的使用,也就是uniswap中的<strong>UniswapV2Factory</strong>合约中的createPair方法.具体的信息可参考<a href="https://eips.ethereum.org/EIPS/eip-1014" target="_blank" rel="noopener">eip1014</a>与<a href="https://blog.ricmoo.com/wisps-the-magical-world-of-create2-5c2177027604" target="_blank" rel="noopener">the-magical-world-of-create2</a>.</p>
</blockquote>
<h4 id="create2的使用方式"><a href="#create2的使用方式" class="headerlink" title="create2的使用方式"></a>create2的使用方式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bytes memory bytecode = type(UniswapV2Pair).creationCode;</span><br><span class="line">bytes32 salt = keccak256(abi.encodePacked(token0, token1));</span><br><span class="line">    assembly &#123;</span><br><span class="line">         pair := create2(<span class="number">0</span>, add(bytecode, <span class="number">32</span>), mload(bytecode), salt)</span><br><span class="line">   &#125;</span><br><span class="line">     IUniswapV2Pair(pair).initialize(token0, token1);</span><br></pre></td></tr></table></figure>
<ul>
<li>此处主要注意看以上两行代码,按照字面意思我们需要<strong>UniswapV2Pair</strong>的合约, <strong>token0, token1</strong>组成的salt,最后面再调用UniswapV2Pair的初始化函数,即完成了整个create2的使用,</li>
<li>对的,就是这么简单.那么这样单独抽出一个<strong>UniswapV2Factory</strong>的作用是什么呢?</li>
<li><p>因为我们是批量创建相同的合约,只是每个合约的里面记录的数据不同而已,所以这里我们还得引入另一个合约函数来配合使用,他就是<br><a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/libraries/UniswapV2Library.sol" target="_blank" rel="noopener">UniswapV2Library</a>中的pairFor方法,此方法可以根据创建的参数返回正确的合约地址.其中factory参数就是上述使用create2的合约地址</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculates the CREATE2 address for a pair without making any external calls</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pairFor</span>(<span class="params">address factory, address tokenA, address tokenB</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">address pair</span>) </span>&#123;</span><br><span class="line">    (address token0, address token1) = sortTokens(tokenA, tokenB);</span><br><span class="line">    pair = address(uint(keccak256(abi.encodePacked(</span><br><span class="line">            hex<span class="string">'ff'</span>,			<span class="comment">// 固定值</span></span><br><span class="line">            factory,			<span class="comment">// 使用create2的合约地址</span></span><br><span class="line">            keccak256(abi.encodePacked(token0, token1)), <span class="comment">// 确定唯一的合约</span></span><br><span class="line">            hex<span class="string">'96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f'</span> <span class="comment">// init code hash</span></span><br><span class="line">        ))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="学以致用"><a href="#学以致用" class="headerlink" title="学以致用"></a>学以致用</h4><blockquote>
<p>此处我们使用create2实现一个功能,记录Apple手机的制作流程,具体使用AppleFactory定义手机的信息,然后把指定具体的工厂来加工生产出Apple,并将数据保存在区块链上</p>
</blockquote>
<ol>
<li>一台手机包括唯一序列号,外观颜色,运行内存大小,以及存储空间,这里加了一个加工次数来记录整个流程,其中核心方法<strong>initialize</strong>为初始化此产品的基本信息,<br><strong>processAction</strong>记录加工流程, <strong>updatePlayer</strong>交接给下一个工厂完成继续制造</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line">pragma experimental ABIEncoderV2;</span><br><span class="line"></span><br><span class="line">contract Apple &#123;</span><br><span class="line">    struct Action &#123;</span><br><span class="line">        uint step;</span><br><span class="line">        string <span class="keyword">from</span>;</span><br><span class="line">        string to;</span><br><span class="line">        uint256 time;</span><br><span class="line">        address player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint256 public id;                      <span class="comment">// 序列号</span></span><br><span class="line">    string public color;                    <span class="comment">//颜色</span></span><br><span class="line">    uint256 public flashMemory;             <span class="comment">// 运行内存大小 4g</span></span><br><span class="line">    uint256 public diskMemory;              <span class="comment">//  储存空间大小 256g</span></span><br><span class="line">    address public player;                  <span class="comment">// 可以更新此合约数据的用户</span></span><br><span class="line">    uint256 public actionCount;             <span class="comment">// 总共加工次数</span></span><br><span class="line">    Action[] public actions;</span><br><span class="line">    address public factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getApple</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">view</span></span></span><br><span class="line"><span class="function">    <span class="title">returns</span> (<span class="params">uint _id, uint _memory, uint _disk, uint _count, address _player, string memory _color</span>)</span>&#123;</span><br><span class="line">        _id = id;</span><br><span class="line">        _memory = flashMemory;</span><br><span class="line">        _disk = diskMemory;</span><br><span class="line">        _count = actionCount;</span><br><span class="line">        _player = player;</span><br><span class="line">        _color = color;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        factory = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Trace(address player, string <span class="keyword">from</span>, string to, uint256 time);</span><br><span class="line">    event PlayerUpdate(address _pre, address newPlayer, uint256 time);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        address _player,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _id,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _memory,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _disk,</span></span></span><br><span class="line"><span class="function"><span class="params">        string memory _color</span>)</span></span><br><span class="line"><span class="function">    <span class="title">external</span> </span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.sender == factory, <span class="string">"permission deny"</span>);</span><br><span class="line">        player = _player;</span><br><span class="line">        id = _id;</span><br><span class="line">        color = _color;</span><br><span class="line">        flashMemory = _memory;</span><br><span class="line">        diskMemory = _disk;</span><br><span class="line">        _processAction(<span class="string">"apple"</span>, <span class="string">"init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getActions</span>(<span class="params">uint _start, uint _end</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">Action[] memory atcs</span>)</span>&#123;</span><br><span class="line">        uint end = _end + <span class="number">1</span> &gt;=  actions.length ? actions.length : _end;</span><br><span class="line">        atcs = <span class="keyword">new</span> Action[](end - _start);</span><br><span class="line">        <span class="keyword">for</span> (uint i = _start; i &lt; end; i++) &#123;</span><br><span class="line">            atcs[i - _start] = actions[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyPlayer &#123;</span><br><span class="line">        <span class="built_in">require</span>(player == msg.sender, <span class="string">"permission deny"</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">updatePlayer</span>(<span class="params">address _player</span>) <span class="title">onlyPlayer</span> <span class="title">external</span> </span>&#123;</span><br><span class="line">        address oldPlayer = player;</span><br><span class="line">        player = _player;</span><br><span class="line">        emit PlayerUpdate(oldPlayer, _player, block.timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_processAction</span>(<span class="params">string memory _from, string memory _to</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">        actionCount += <span class="number">1</span>;</span><br><span class="line">        actions.push(Action(&#123;<span class="attr">from</span> : _from, <span class="attr">to</span> : _to, <span class="attr">time</span> : block.timestamp, <span class="attr">step</span> : actionCount,<span class="attr">player</span>:msg.sender&#125;));</span><br><span class="line">        emit Trace(player, _from, _to, block.timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">processAction</span>(<span class="params">string memory _from, string memory _to</span>) <span class="title">onlyPlayer</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        _processAction(_from, _to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>factory合约应由苹果公司根据实际的生产情况进行管理,并录入基本信息(此处由于测试,任何人都可以创建),此处的<strong>makeApple</strong>即使生产apple, <strong>getApple</strong>可以用来得到生产出来的apple的具体合约地址,</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./Apple.sol"</span>;</span><br><span class="line"></span><br><span class="line">interface IApple &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params">address _player, uint256 _id, uint256 _mem, uint256 _disk, string memory _c</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">AppleFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    address[] public apples;</span><br><span class="line"></span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> bool) public checkApple;</span><br><span class="line">    </span><br><span class="line">    bytes32 public hash;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getAllApples</span>(<span class="params">uint _start, uint _end</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">address[] memory _apples</span>)</span>&#123;</span><br><span class="line">        _apples = <span class="keyword">new</span> address[](_end - _start);</span><br><span class="line">        <span class="keyword">for</span>(uint i = _start; i &lt; _end ; i++)&#123;</span><br><span class="line">            _apples[i - _start] = apples[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">totalApple</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> apples.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event AppleCreated(address maker, uint256 _id, uint256 _memory, uint256 _disk, string _color, address _apple);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">makeApple</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _memory,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _disk,</span></span></span><br><span class="line"><span class="function"><span class="params">        string memory _color</span>)</span></span><br><span class="line"><span class="function">    <span class="title">external</span> <span class="title">returns</span> (<span class="params">address apple</span>) </span>&#123;</span><br><span class="line">        uint256 _id = apples.length + <span class="number">1</span>;</span><br><span class="line">        bytes memory bytecode = type(Apple).creationCode;</span><br><span class="line">        <span class="keyword">if</span> (hash == bytes32(<span class="number">0</span>)) &#123;</span><br><span class="line">            hash = keccak256(bytecode);</span><br><span class="line">        &#125;</span><br><span class="line">        bytes32 salt = keccak256(abi.encodePacked(_id, _memory, _color));</span><br><span class="line">        assembly &#123;</span><br><span class="line">            apple := create2(<span class="number">0</span>, add(bytecode, <span class="number">32</span>), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">require</span>(checkApple[apple] == <span class="literal">false</span>, <span class="string">'this apple have been made'</span>);</span><br><span class="line">        IApple(apple).initialize(msg.sender, _id, _memory, _disk, _color);</span><br><span class="line">        apples.push(apple);</span><br><span class="line">        emit AppleCreated(msg.sender, _id, _memory, _disk, _color, apple);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// 可以通过同样的参数计算出对应的合约地址</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getApple</span>(<span class="params">int256 _id, uint256 _memory, uint256 _disk, string calldata _color</span>)</span></span><br><span class="line"><span class="function">    <span class="title">external</span></span></span><br><span class="line"><span class="function">    <span class="title">view</span></span></span><br><span class="line"><span class="function">    <span class="title">returns</span> (<span class="params">address apple</span>)</span>&#123;</span><br><span class="line">        apple = address(uint(keccak256(abi.encodePacked(</span><br><span class="line">                hex<span class="string">'ff'</span>,</span><br><span class="line">                address(<span class="keyword">this</span>),</span><br><span class="line">                keccak256(abi.encodePacked(_id, _memory, _disk, _color)),</span><br><span class="line">                hash</span><br><span class="line">            ))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/xswap/ether4.gif" alt="demo"></p>
<h4 id="demo演示"><a href="#demo演示" class="headerlink" title="demo演示"></a>demo演示</h4><ul>
<li><a href="https://github.com/shaokun11/xswap/tree/v2" target="_blank" rel="noopener">前端源码</a>,<a href="https://github.com/shaokun11/solidity-env-hardhat/tree/v3" target="_blank" rel="noopener">合约源码</a></li>
<li>首先制造成产了一台iPhone,填入颜色,内存与储存空间</li>
<li>进入加工环节,当执行process时,自动进入到下一个加工环节</li>
<li>…</li>
<li>跟随者加工流程指导加工生产完成,这样可以记录每一台手机的生产流程,且具体的流程可信</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>可以按照编程语言中的面向对象思想进行理解,create2传入的参数bytecode就是class的字节码,而create2相当于new,而我们又可以根据传入create2加上其factory的地址以及salt恢复找到以这salt为key的合约地址且唯一,而且合约的地址提前可知呢.Ó´</li>
<li>那么按照介绍使用create2,我们需要两个合约,一个template合约(类),一个factory合约(负责new)即可,是不是很简单的?</li>
<li>如果使用create2创建了一个合约,再使用同样的参数进行调用,是不能成功的,除非已创建的合约调用selfdestruct(address)释放掉才行</li>
<li>接下来就可以进入到在第一篇文章中所提到的三个合约中的<strong>UniswapV2Pair</strong>,也即使最后一个合约</li>
<li>其实到这里来说,合约知识中的难点已经讲解的差不多了,剩下的其实是关于uniswap中的创新思想的复习咯</li>
</ol>
<h4 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h4><p>区块链程序猿一枚<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/27/uniswap 源码解读3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/27/uniswap 源码解读3/" itemprop="url">一步一步教你打造自己的defi-xswap(3)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-27T20:15:25+08:00">
                2020-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>本篇文章主要看看UniswapV2Pair的父类合约UniswapV2ERC20,主要学习一下eip712</p>
</blockquote>
<h4 id="UniswapV2ERC20"><a href="#UniswapV2ERC20" class="headerlink" title="UniswapV2ERC20"></a>UniswapV2ERC20</h4><blockquote>
<p>此合约如果熟悉ERC20 token的同学一定知道,她其实是标准的erc20合约(其标准的erc20合约的内容此处就不再详细介绍了)<br>但是相对标准的erc20合约多了一个permit方法,那么这个方法的作用是什么什么呢?其实是eip721的一个实现</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">contract UniswapV2ERC20 is IUniswapV2ERC20 &#123;</span><br><span class="line">    using SafeMath <span class="keyword">for</span> uint;</span><br><span class="line"></span><br><span class="line">    string public constant name = <span class="string">'Uniswap V2'</span>;</span><br><span class="line">    string public constant symbol = <span class="string">'UNI-V2'</span>;</span><br><span class="line">    uint8 public constant decimals = 18;</span><br><span class="line">    uint  public totalSupply;</span><br><span class="line">    mapping(address =&gt; uint) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint)) public allowance;</span><br><span class="line"></span><br><span class="line">    bytes32 public DOMAIN_SEPARATOR;</span><br><span class="line">    // keccak256(<span class="string">"Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"</span>);</span><br><span class="line">    bytes32 public constant PERMIT_TYPEHASH = 0x6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c9;</span><br><span class="line">    mapping(address =&gt; uint) public nonces;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        uint chainId;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            chainId := chainid</span><br><span class="line">        &#125;</span><br><span class="line">        DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">            abi.encode(</span><br><span class="line">                keccak256(<span class="string">'EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)'</span>),</span><br><span class="line">                keccak256(bytes(name)),</span><br><span class="line">                keccak256(bytes(<span class="string">'1'</span>)),</span><br><span class="line">                chainId,</span><br><span class="line">                address(this)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _mint(address to, uint value) internal &#123;</span><br><span class="line">        totalSupply = totalSupply.add(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(address(0), to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _burn(address from, uint value) internal &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        totalSupply = totalSupply.sub(value);</span><br><span class="line">        emit Transfer(from, address(0), value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _approve(address owner, address spender, uint value) private &#123;</span><br><span class="line">        allowance[owner][spender] = value;</span><br><span class="line">        emit Approval(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _transfer(address from, address to, uint value) private &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> approve(address spender, uint value) external returns (bool) &#123;</span><br><span class="line">        _approve(msg.sender, spender, value);</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> transfer(address to, uint value) external returns (bool) &#123;</span><br><span class="line">        _transfer(msg.sender, to, value);</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> transferFrom(address from, address to, uint value) external returns (bool) &#123;</span><br><span class="line">        <span class="keyword">if</span> (allowance[from][msg.sender] != uint(-1)) &#123;</span><br><span class="line">            allowance[from][msg.sender] = allowance[from][msg.sender].sub(value);</span><br><span class="line">        &#125;</span><br><span class="line">        _transfer(from, to, value);</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external &#123;</span><br><span class="line">        require(deadline &gt;= block.timestamp, <span class="string">'UniswapV2: EXPIRED'</span>);</span><br><span class="line">        bytes32 digest = keccak256(</span><br><span class="line">            abi.encodePacked(</span><br><span class="line">                <span class="string">'\x19\x01'</span>,</span><br><span class="line">                DOMAIN_SEPARATOR,</span><br><span class="line">                keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, nonces[owner]++, deadline))</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        address recoveredAddress = ecrecover(digest, v, r, s);</span><br><span class="line">        require(recoveredAddress != address(0) &amp;&amp; recoveredAddress == owner, <span class="string">'UniswapV2: INVALID_SIGNATURE'</span>);</span><br><span class="line">        _approve(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="UniswapV2ERC20中的eip712"><a href="#UniswapV2ERC20中的eip712" class="headerlink" title="UniswapV2ERC20中的eip712"></a>UniswapV2ERC20中的eip712</h4><ol>
<li><a href="https://github.com/0xProject/EIPs/blob/master/EIPS/eip-712.md" target="_blank" rel="noopener">eip712</a>其实是也是用你的私钥对一段文字进行签名,但是签名的过程中更加语义化,目前metamask已经支持,接下来看看premit中的核心方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bytes32 digest = keccak256(</span><br><span class="line">         abi.encodePacked(</span><br><span class="line">             &apos;\x19\x01&apos;,</span><br><span class="line">             DOMAIN_SEPARATOR,</span><br><span class="line">             keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, nonces[owner]++, deadline))</span><br><span class="line">         )</span><br><span class="line">     );</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>第一个参数 <strong>\x19\x01</strong> 固定值,为什么选择这个?请参考上面的链接</li>
<li>第二个参数:<strong>DOMAIN_SEPARATOR</strong> 其签名一般如下,固定值,在合约的构造函数中初始化,标志着只是eip712的实现</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)</span><br><span class="line"> constructor() public &#123;</span><br><span class="line">       uint chainId;</span><br><span class="line">       assembly &#123;</span><br><span class="line">           chainId := chainid</span><br><span class="line">       &#125;</span><br><span class="line">       DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">           abi.encode(</span><br><span class="line">               keccak256(<span class="string">'EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)'</span>),</span><br><span class="line">               keccak256(bytes(name)),	</span><br><span class="line">               keccak256(bytes(<span class="string">'1'</span>)),</span><br><span class="line">               chainId,</span><br><span class="line">               address(this)</span><br><span class="line">           )</span><br><span class="line">       );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>第三个参数的前段部分 <strong>PERMIT_TYPEHASH</strong>,与DOMAIN_SEPARATOR的含义类似,代表着这个函数的签名</li>
<li>第三个参数的后端部分统一理解为传进来signature对应的数据,此处用v,r,s代替  </li>
</ol>
<h4 id="eip712的简单实现"><a href="#eip712的简单实现" class="headerlink" title="eip712的简单实现"></a>eip712的简单实现</h4><ul>
<li><p>此处采用的结构为 <strong>keccak256(‘Test(address owner,uint256 amount,uint256 nonce)’)</strong>,此处注意数据类型和字段名中间有一个空格,参数之间的逗号之间没有空格     </p>
</li>
<li><p>eip712主要功能是能够离线签名,让任意的人可以代替你做同样的事情,相当于授权.此处仅做演示签名后的地址正确性  </p>
</li>
<li><p>此处仅测试验证结果成功即增加用户输入的amount </p>
</li>
<li><p><a href="https://github.com/shaokun11/solidity-env-hardhat/blob/master/contracts/TestEip712.sol" target="_blank" rel="noopener">合约源码</a></p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    bytes32 public DOMAIN_SEPARATOR;</span><br><span class="line">    address public rc;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public nonces;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public amounts;</span><br><span class="line">    bytes32 public constant TEST_TYPEHASH = keccak256(<span class="string">'Test(address owner,uint256 amount,uint256 nonce)'</span>);</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        uint chainId;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            chainId := chainid() <span class="comment">// 大于6.0以上是个方法,不是属性</span></span><br><span class="line">        &#125;</span><br><span class="line">        DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">            abi.encode(</span><br><span class="line">                keccak256(<span class="string">'EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)'</span>),</span><br><span class="line">                keccak256(bytes(<span class="string">"shaokun"</span>)), <span class="comment">// 此处一般填写此合约有意义的值</span></span><br><span class="line">                keccak256(bytes(<span class="string">'1'</span>)),</span><br><span class="line">                chainId,</span><br><span class="line">                address(<span class="keyword">this</span>)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testEIP712</span>(<span class="params">address owner, uint256 amount, uint8 v, bytes32 r, bytes32 s</span>) <span class="title">external</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        bytes32 digest = keccak256(</span><br><span class="line">            abi.encodePacked(<span class="string">'\x19\x01'</span>,</span><br><span class="line">            DOMAIN_SEPARATOR,</span><br><span class="line">            keccak256(abi.encode(TEST_TYPEHASH, owner, amount, nonces[owner]++))</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        address recoveredAddress = ecrecover(digest, v, r, s);</span><br><span class="line">        <span class="built_in">require</span>(recoveredAddress != address(<span class="number">0</span>) &amp;&amp; recoveredAddress == owner, <span class="string">"account not fit"</span>);</span><br><span class="line">        rc = recoveredAddress;</span><br><span class="line">        amounts[owner] += amount;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="流程演示"><a href="#流程演示" class="headerlink" title="流程演示"></a>流程演示</h4><blockquote>
<p>这一周花了点时间用react做了个UI,使用了react + react-material开发UI,web3-react实现与区块链的交互<a href="https://github.com/shaokun11/xswap" target="_blank" rel="noopener">xswap前端</a></p>
</blockquote>
<ol>
<li>使用remix部署合约在rinkeby测试链上,合约地址<strong>0x9F8C390b7048395d4DeBc7636031aD992115C303</strong> <a href="https://rinkeby.etherscan.io/address/0x9F8C390b7048395d4DeBc7636031aD992115C303" target="_blank" rel="noopener">ethersacn</a></li>
<li>从链上读出当前签名所用的nonce</li>
<li>根据nonce与amount使用账号进行签名,并发送到链上</li>
<li>当交易执行成功,获取新的nonce和amount,验证结果</li>
<li>再次执行签名,将获取的签名数据(其中如果数量为25,发送将会提醒失败,改为签名的数据19则正常弹出metamask)通过remix发送,等待交易结果后返回页面查询数据已经更改  </li>
</ol>
<p><img src="/xswap/ether3.gif" alt="demo"></p>
<h4 id="js签名流程"><a href="#js签名流程" class="headerlink" title="js签名流程"></a>js签名流程</h4><blockquote>
<p>目前web3不支持此类签名方式,metamask是支持的,请注意一下签名的请求方式</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两个字段 types与domain</span></span><br><span class="line"><span class="keyword">const</span> eip712Obj = &#123;</span><br><span class="line">    types: &#123;</span><br><span class="line">        EIP712Domain: [</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'name'</span>, <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'version'</span>, <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'chainId'</span>, <span class="attr">type</span>: <span class="string">'uint256'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'verifyingContract'</span>, <span class="attr">type</span>: <span class="string">'address'</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="comment">// 签名的结构,与合约保持一致</span></span><br><span class="line">        Test: [</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'owner'</span>, <span class="attr">type</span>: <span class="string">'address'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'amount'</span>, <span class="attr">type</span>: <span class="string">'uint256'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'nonce'</span>, <span class="attr">type</span>: <span class="string">'uint256'</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">   	</span><br><span class="line">    domain: <span class="function">(<span class="params">chainId: number</span>) =&gt;</span> (&#123;</span><br><span class="line">        name: <span class="string">'shaokun'</span>,</span><br><span class="line">        version: <span class="string">'1'</span>,</span><br><span class="line">        chainId: chainId,</span><br><span class="line">        verifyingContract: <span class="string">'0x9F8C390b7048395d4DeBc7636031aD992115C303'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">// 签名所要的数据</span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            types: eip712Obj.types,		</span><br><span class="line">            domain: eip712Obj.domain(web3.chainId!!), <span class="comment">// 获取当前的id,并返回与合约一致的数据</span></span><br><span class="line">            primaryType: <span class="string">'Test'</span>,	<span class="comment">// 最开始hash的类型,如果有多个类型,需指定按照合约的顺序的第一个</span></span><br><span class="line">            <span class="comment">// test的数据具体内容</span></span><br><span class="line">            message: &#123;</span><br><span class="line">                owner: web3.account,</span><br><span class="line">                amount: inputV,</span><br><span class="line">                nonce,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 此处使用的web3-react,provider 为metamask</span></span><br><span class="line"> web3.library.provider.request(</span><br><span class="line">            &#123;</span><br><span class="line">                method: <span class="string">'eth_signTypedData_v4'</span>,</span><br><span class="line">                params: [web3.account, data],   <span class="comment">// 两个参数,第一个必须为账号地址,第二个</span></span><br><span class="line">            &#125;).then(<span class="function">(<span class="params">result: string</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> signature = result.substring(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">const</span> r = <span class="string">'0x'</span> + signature.substring(<span class="number">0</span>, <span class="number">64</span>)</span><br><span class="line">            <span class="keyword">const</span> s = <span class="string">'0x'</span> + signature.substring(<span class="number">64</span>, <span class="number">128</span>)</span><br><span class="line">            <span class="keyword">const</span> v = <span class="built_in">parseInt</span>(signature.substring(<span class="number">128</span>, <span class="number">130</span>), <span class="number">16</span>)</span><br><span class="line">            <span class="comment">// 得到签名结果的r,s,v,发送到链上校验即可</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'---sign result -'</span>,&#123;r,s,v&#125;)</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>关于语义化签名的就介绍到此了,那么uniswap中的permit的作用就是也就是如此,至于怎么使用它是怎么使用的呢,后续再看吧</li>
<li>UniswapV2ERC20 基础合约就没有什么难点了,其余的方法为标准的erc20 token的方法</li>
<li>接下来讲解<em>UniswapV2Factory</em>,又是一个开发智能合约很重要的一个知识点呢</li>
</ul>
<h4 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h4><p>区块链程序猿一枚<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/25/uniswap 源码解读2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/25/uniswap 源码解读2/" itemprop="url">一步一步教你打造自己的defi-xswap(2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-25T11:22:06+08:00">
                2020-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>本篇文章主要看看uniswap的合约的源码和结构,以及如何找到源码的入口(当然也可以直接阅读uniswap的doc来达到目的)</p>
</blockquote>
<h4 id="获取源码"><a href="#获取源码" class="headerlink" title="获取源码"></a>获取源码</h4><p>从<a href="https://github.com/Uniswap/uniswap-v2-core" target="_blank" rel="noopener">uniswap合约源码 github</a>把源码colne到本地,进入contract目录  </p>
<ul>
<li>可以看到合约的代码量不多,那么我们该如何开始呢?</li>
<li>从目录的命名来看,我们貌似只需要关注暴露在外面的三个合约 UniswapV2ERC20.sol, UniswapV2Factory.sol, UniswapV2Pair.sol即可,其他的文件夹的内容为interface和libraries</li>
</ul>
<blockquote>
<p>这里如果不熟悉的同学可以试着run一下这个这个test,然后根据test去查看项目如何执行的</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--  1 kun  staff  3435 10 25 11:14 UniswapV2ERC20.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  1867 10 25 11:14 UniswapV2Factory.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  9788 10 25 11:14 UniswapV2Pair.sol</span><br><span class="line">drwxr-xr-x  7 kun  staff   238 10 25 11:14 interfaces</span><br><span class="line">drwxr-xr-x  5 kun  staff   170 10 25 11:14 libraries</span><br><span class="line">drwxr-xr-x  3 kun  staff   102 10 25 11:14 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">./interfaces:</span><br><span class="line">total 40</span><br><span class="line">-rw-r--r--  1 kun  staff   823 10 25 11:14 IERC20.sol</span><br><span class="line">-rw-r--r--  1 kun  staff   159 10 25 11:14 IUniswapV2Callee.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  1148 10 25 11:14 IUniswapV2ERC20.sol</span><br><span class="line">-rw-r--r--  1 kun  staff   661 10 25 11:14 IUniswapV2Factory.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  2424 10 25 11:14 IUniswapV2Pair.sol</span><br><span class="line"></span><br><span class="line">./libraries:</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r--  1 kun  staff  602 10 25 11:14 Math.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  563 10 25 11:14 SafeMath.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  578 10 25 11:14 UQ112x112.sol</span><br><span class="line"></span><br><span class="line">./<span class="built_in">test</span>:</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--  1 kun  staff  187 10 25 11:14 ERC20.sol</span><br></pre></td></tr></table></figure>
<h4 id="试玩uniswap"><a href="#试玩uniswap" class="headerlink" title="试玩uniswap"></a>试玩uniswap</h4><ol>
<li><a href="https://rinkeby.etherscan.io/tx/0x4f1551395b26afa5b270c42bf165e9a013db010b3e585bf9419a63e83866081d" target="_blank" rel="noopener">eth兑换uni</a>,从etherscan中可以看到函数签名为<strong>swapExactETHForTokens</strong>   </li>
<li><a href="https://rinkeby.etherscan.io/tx/0x4f1551395b26afa5b270c42bf165e9a013db010b3e585bf9419a63e83866081d" target="_blank" rel="noopener">添加uni-&gt;eth的资金池</a>,调用的函数签名为<strong>addLiquidityETH</strong>,(中间approve了两次此合约可以转移我钱包中的uni的操作,第二次是重复的)  </li>
<li>那么我们可以从这两个函数开始阅读其合约代码   </li>
</ol>
<p><img src="/xswap/ether2.gif" alt="demo"></p>
<h4 id="router合约"><a href="#router合约" class="headerlink" title="router合约"></a>router合约</h4><ol>
<li>在我们试玩找入口时,我们发现其调用的函数签名并没有在我们Colne的项目中有找到,那是怎么回事呢?按照文档,这是uniswap为我们的sdk,我们可以根据这基础的合约创建属于我们的swap(是的,我们正在做这件事),而他们自己也做了一个swap <a href="https://github.com/Uniswap/uniswap-v2-periphery" target="_blank" rel="noopener">uniswap合约源码</a>,这个才是他们基于sdk开发的一个应用呢</li>
<li>那我们根据<a href="https://rinkeby.etherscan.io/tx/0x4f1551395b26afa5b270c42bf165e9a013db010b3e585bf9419a63e83866081d" target="_blank" rel="noopener">eth兑换uni</a>这笔交易,找到其在etherscan上验证过的的合约,发现其实际调用的是<em>UniswapV2Router02</em>这个函数名的合约,全局搜索找到其函数签名如下  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline)</span><br><span class="line">     external</span><br><span class="line">     virtual</span><br><span class="line">     override</span><br><span class="line">     payable</span><br><span class="line">     ensure(deadline)</span><br><span class="line">     returns (uint[] memory amounts)</span><br><span class="line"> &#123;</span><br><span class="line">     require(path[0] == WETH, &apos;UniswapV2Router: INVALID_PATH&apos;);</span><br><span class="line">     amounts = UniswapV2Library.getAmountsOut(factory, msg.value, path);</span><br><span class="line">     require(amounts[amounts.length - 1] &gt;= amountOutMin, &apos;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&apos;);</span><br><span class="line">     IWETH(WETH).deposit&#123;value: amounts[0]&#125;();</span><br><span class="line">     assert(IWETH(WETH).transfer(UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]));</span><br><span class="line">     _swap(amounts, path, to);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>先忽略<strong>UniswapV2Library</strong>方法,观察此合约,其核心方法集中在<strong>_swap(amounts, path, to)</strong>这个方法上,继续搜索可以发现很多方法都调用了此方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// **** SWAP ****</span><br><span class="line">// requires the initial amount to have already been sent to the first pair</span><br><span class="line">function _swap(uint[] memory amounts, address[] memory path, address _to) internal virtual &#123;</span><br><span class="line">    for (uint i; i &lt; path.length - 1; i++) &#123;</span><br><span class="line">        (address input, address output) = (path[i], path[i + 1]);</span><br><span class="line">        (address token0,) = UniswapV2Library.sortTokens(input, output);</span><br><span class="line">        uint amountOut = amounts[i + 1];</span><br><span class="line">        (uint amount0Out, uint amount1Out) = input == token0 ? (uint(0), amountOut) : (amountOut, uint(0));</span><br><span class="line">        address to = i &lt; path.length - 2 ? UniswapV2Library.pairFor(factory, output, path[i + 2]) : _to;</span><br><span class="line">        IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(</span><br><span class="line">            amount0Out, amount1Out, to, new bytes(0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>发现其最终落在了**IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(<pre><code>    amount0Out, amount1Out, to, new bytes(0)
);**这个方法上,这个方法就在我们的clone项目中了,那么其核心方法我们就只要关心**IUniswapV2Pair. swap()**  
5. 为什么我们colne项目中没有这个router的合约? (本系列结束后回答)  
</code></pre></li>
</ol>
<blockquote>
<p>只有在etherscan上验证过的合约才能够找到其合约元am,这也是最真实的,如果做defi,一般会将其验证,增加其去中心化的公信力</p>
</blockquote>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li><p>通过一系列的操作,我们总算找到了合约入口啦,接下来应该进入到正式的合约阅读步骤啦,是不是很激动?</p>
</li>
<li><p>其中有些细节我觉得通过文字来描述就有点啰嗦了,然后就跳过了,如果你感觉到其中哪些地方迷糊,可以给我发邮件</p>
</li>
</ol>
<h4 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h4><p>区块链程序猿一枚<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/24/uniswap 源码解读1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/24/uniswap 源码解读1/" itemprop="url">一步一步教你打造自己的defi-xswap(1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-24T18:31:22+08:00">
                2020-10-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p><a href="https://etherscan.io/address/0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f#code" target="_blank" rel="noopener">uniswap合约源码 etherscan</a><br><a href="https://github.com/Uniswap/uniswap-v2-core" target="_blank" rel="noopener">uniswap合约源码 github</a><br>由于在工作中已经基于uniswap实现了更多玩法的defi,在此把其中的流程再梳理一下<br>本系列文章仅作为uniswap的源码理解以及带你如何实现一个自己的xswap,其他玩法请各位同学自己发挥了</p>
</blockquote>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ol>
<li>编程语言 <ul>
<li><strong>solidity</strong>(写以太坊合约的语言),</li>
<li><strong>nodejs</strong> (开发环境)</li>
<li><strong>react</strong>(写web前端)</li>
</ul>
</li>
<li>工具<ul>
<li>metamask(以太坊钱包)</li>
<li>以太坊账号,由于计划合约部署在rinkeby上,所以得去领一些ether</li>
<li>梯子,这个你懂的</li>
</ul>
</li>
</ol>
<h4 id="搭建以太坊开发环境"><a href="#搭建以太坊开发环境" class="headerlink" title="搭建以太坊开发环境"></a>搭建以太坊开发环境</h4><ol>
<li><a href="http://remix.ethereum.org/#optimize=false&amp;version=soljson-v0.5.1+commit.c8a2cb62.js" target="_blank" rel="noopener">remix</a>,</li>
<li><a href="https://www.trufflesuite.com/" target="_blank" rel="noopener">truffle</a>,</li>
<li><a href="https://getwaffle.io/" target="_blank" rel="noopener">waffle</a>,</li>
<li><a href="https://hardhat.org/" target="_blank" rel="noopener">Hardhat</a></li>
<li><a href="https://github.com/shaokun11/solidity-env-hardhat" target="_blank" rel="noopener">演示用的</a>  (主要是将官方demo改为ts版本)  </li>
</ol>
<blockquote>
<p> 至于怎么选择,合适自己的就是最好的</p>
</blockquote>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>此部分代码为demo代码,如果你和我选用的是同一个框架,应该和下面是一样的  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//SPDX-License-Identifier: Unlicense</span><br><span class="line">pragma solidity ^0.7.0;</span><br><span class="line"></span><br><span class="line">import &quot;hardhat/console.sol&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Greeter &#123;</span><br><span class="line">  string greeting;</span><br><span class="line"></span><br><span class="line">  constructor(string memory _greeting) &#123;</span><br><span class="line">    // 这里可以打印console,所以选择了这个框架进行开发</span><br><span class="line">    console.log(&quot;Deploying a Greeter with greeting:&quot;, _greeting);</span><br><span class="line">    greeting = _greeting;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function greet() public view returns (string memory) &#123;</span><br><span class="line">    return greeting;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function setGreeting(string memory _greeting) public &#123;</span><br><span class="line">    console.log(&quot;Changing greeting from &apos;%s&apos; to &apos;%s&apos;&quot;, greeting, _greeting);</span><br><span class="line">    greeting = _greeting;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试脚本</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;expect&#125; = <span class="built_in">require</span>(<span class="string">"chai"</span>);</span><br><span class="line"><span class="comment">//@ts-ignore</span></span><br><span class="line"><span class="keyword">import</span> &#123;ethers&#125; <span class="keyword">from</span> <span class="string">"hardhat"</span>;</span><br><span class="line"><span class="keyword">import</span> chai <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Wallet&#125; <span class="keyword">from</span> <span class="string">"ethers"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;deployContract, solidity&#125; <span class="keyword">from</span> <span class="string">"ethereum-waffle"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Greeter"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">	it(<span class="string">"Should return the new greeting once it's changed"</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">const</span> Greeter = <span class="keyword">await</span> ethers.getContractFactory(<span class="string">"Greeter"</span>);</span><br><span class="line">		<span class="keyword">const</span> greeter = <span class="keyword">await</span> Greeter.deploy(<span class="string">"Hello, world!"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">await</span> greeter.deployed();</span><br><span class="line">		expect(<span class="keyword">await</span> greeter.greet()).to.equal(<span class="string">"Hello, world!"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">await</span> greeter.setGreeting(<span class="string">"Hola, mundo!"</span>);</span><br><span class="line">		expect(<span class="keyword">await</span> greeter.greet()).to.equal(<span class="string">"Hola, mundo!"</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="环境搭建结果演示"><a href="#环境搭建结果演示" class="headerlink" title="环境搭建结果演示"></a>环境搭建结果演示</h4><ol>
<li>本地开发启动节点</li>
<li>编写测试脚本<br><img src="/xswap/ether1.gif" alt="demo"><h4 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h4>区块链技术痴迷的程序猿一枚</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/16/koa+graphql定义你的接口/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/16/koa+graphql定义你的接口/" itemprop="url">koa + graphql的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-16T13:13:14+08:00">
                2020-08-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><blockquote>
<p>完成http请求到graphql的请求改造</p>
</blockquote>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><blockquote>
<p>内容大部分来自己graphql与apollo-server官网, 内部加上自己的一些理解,至于改造嘛,就自己动手咯</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; ApolloServer, gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-koa"</span>);</span><br><span class="line"><span class="keyword">const</span> GraphQLJSON = <span class="built_in">require</span>(<span class="string">"graphql-type-json"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; GraphQLScalarType &#125; = <span class="built_in">require</span>(<span class="string">"graphql"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; Kind &#125; = <span class="built_in">require</span>(<span class="string">"graphql/language"</span>);</span><br><span class="line"><span class="keyword">const</span> books = [</span><br><span class="line">  &#123;</span><br><span class="line">    title: <span class="string">"Harry Potter and the Chamber of Secrets"</span>,</span><br><span class="line">    author: <span class="string">"J.K. Rowling"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    title: <span class="string">"Jurassic Park"</span>,</span><br><span class="line">    author: <span class="string">"Michael Crichton"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> users = [</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">"1"</span>,</span><br><span class="line">    name: <span class="string">"Elizabeth Bennet"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">"2"</span>,</span><br><span class="line">    name: <span class="string">"Fitzwilliam Darcy"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> typeDefs = gql<span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    #   返回字符串</span></span><br><span class="line"><span class="string">    hello: String</span></span><br><span class="line"><span class="string">    # 返回数组</span></span><br><span class="line"><span class="string">    books: [Book]</span></span><br><span class="line"><span class="string">    # 通过参数查询</span></span><br><span class="line"><span class="string">    user(id: ID): User</span></span><br><span class="line"><span class="string">    info(date: Date): String</span></span><br><span class="line"><span class="string">    # 读取数据</span></span><br><span class="line"><span class="string">    foo: Foo</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  #使用第三方定义的标量 json类型</span></span><br><span class="line"><span class="string">  scalar JSON</span></span><br><span class="line"><span class="string">    # 使用自定义的date类型</span></span><br><span class="line"><span class="string">  scalar Date</span></span><br><span class="line"><span class="string">  type Foo &#123;</span></span><br><span class="line"><span class="string">    user: JSON</span></span><br><span class="line"><span class="string">    created: Date</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Book &#123;</span></span><br><span class="line"><span class="string">    title: String</span></span><br><span class="line"><span class="string">    author: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type User &#123;</span></span><br><span class="line"><span class="string">    id: ID</span></span><br><span class="line"><span class="string">    name: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  <span class="built_in">JSON</span>: GraphQLJSON, <span class="comment">// 使用第三方的json标量</span></span><br><span class="line">  <span class="built_in">Date</span>: <span class="keyword">new</span> GraphQLScalarType(&#123;</span><br><span class="line">    <span class="comment">// 自定义标量</span></span><br><span class="line">    name: <span class="string">"Date"</span>,</span><br><span class="line">    description: <span class="string">"Date custom scalar type"</span>,</span><br><span class="line">    parseValue(value) &#123;</span><br><span class="line">      <span class="comment">// variables 参数解析路径</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    serialize(value) &#123;</span><br><span class="line">      <span class="keyword">return</span> value.getTime();</span><br><span class="line">    &#125;,</span><br><span class="line">    parseLiteral(ast) &#123;</span><br><span class="line">      <span class="comment">// 字面量参数路径</span></span><br><span class="line">      <span class="keyword">if</span> (ast.kind === Kind.INT) &#123;</span><br><span class="line">        <span class="comment">// ast.value 永远是 字符串类型 所以需要转换</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(+ast.value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  Query: &#123;</span><br><span class="line">    hello: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Hello shaokun!"</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    books: <span class="function"><span class="params">()</span> =&gt;</span> books, <span class="comment">// 直接返回数据库中的books</span></span><br><span class="line">    user(parent, args, context) &#123;</span><br><span class="line">      <span class="comment">// parent 连续查询 中 上一次查询的结果</span></span><br><span class="line">      <span class="comment">// args 查询参数 如上面的id</span></span><br><span class="line">      <span class="comment">// context 全局数据的拿取</span></span><br><span class="line">      <span class="built_in">console</span>.log(parent, args, context.name, context.age);</span><br><span class="line">      <span class="keyword">return</span> users.find(<span class="function">(<span class="params">user</span>) =&gt;</span> user.id === args.id);</span><br><span class="line">    &#125;,</span><br><span class="line">    foo: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        user: &#123; <span class="attr">name</span>: <span class="string">"shaokum"</span> &#125;,   <span class="comment">// 如果返回的不是json类型 则为null</span></span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>(),        <span class="comment">// Date类型 实际返回给前端的是 定义的scalar中的serialize方法</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    info: <span class="function">(<span class="params">_, args</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 查询方式 字面常量方式查询</span></span><br><span class="line">      <span class="comment">// &#123;</span></span><br><span class="line">      <span class="comment">//     info(data:1597552212000)</span></span><br><span class="line">      <span class="comment">// &#125;</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"---info-"</span>, args); <span class="comment">// 通过Date.parseLiteral 方法拿到解析的数据</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">"this date is "</span> + args.date.toString();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context: <span class="keyword">async</span> (request) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 可获取到rquest请求</span></span><br><span class="line">    <span class="comment">// 可以全局挂载,如授权token db实例</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="string">"shaokun"</span>,</span><br><span class="line">      age: <span class="number">18</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`🚀 Server ready at http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h5 id="结果演示"><a href="#结果演示" class="headerlink" title="结果演示"></a>结果演示</h5><p><img src="/react/graphql.gif" alt="graphql query demo"> </p>
<h5 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h5><p>区块链技术痴迷的程序猿一枚，如果你喜欢我的文章，可以加上微信共同学习，共同进步。  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/02/在typescript中使用eosjs-ecc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/02/在typescript中使用eosjs-ecc/" itemprop="url">在typescript中使用eosjs-ecc</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-02T16:19:14+08:00">
                2020-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><ul>
<li>ts开发后端项目,考虑到维护的需要,还是需要ts来支持.其中涉及到的lib都能找到对应的types,但是也有例外比如eosjs-ecc</li>
</ul>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><ol>
<li>简单快速,但是没有任何提示了,IDE基本的提示都没有了,对于直接将.js—&gt;.ts可以使用</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tsconfig.json中将此字段设为false</span></span><br><span class="line">  <span class="string">"noImplicitAny"</span>: <span class="literal">false</span>,</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>自己写 **d.ts,喜欢的同学可以尝试一下</li>
<li><p>工具自动生成,推荐方式<br> -这里使用微软提供的<a href="https://github.com/microsoft/dts-gen" target="_blank" rel="noopener">dts-gen</a>进行生成,放到项目的任意目录即可,但是还是无法使用,这时需要在最外面包裹一层 declare module ‘eosjs-ecc’{}即可,如果使用ts-node执行项目,需要在导入的时候添加ts-ignore,直接使用tsc编译则可以不用</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @ts-ignore</span></span><br><span class="line"><span class="keyword">import</span> ecc <span class="keyword">from</span> <span class="string">'eosjs-ecc'</span></span><br><span class="line">ecc.randomKey(<span class="number">0</span>).then(<span class="function">(<span class="params">privateKey:string</span>) =&gt;</span> &#123;</span><br><span class="line">   	<span class="built_in">console</span>.log(privateKey )</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>优化  </p>
<ul>
<li>细心的同学发现,里面的类型全是any,一点用处都没有啊?<br>但是这样可以有IDE的提示了,ts可以正常写代码了呢  </li>
<li><p>由于一个lib我们不会完全用它的方法,那么我们只需要去修改一下我们需要使用的类型即可.比如randomKey这个方法,我们将它的declare中的按照如下更改即可,再次调用就达到了正常使用lib的目的啦</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export function randomKey(cpuEntropyBits: number ): Promise&lt;string&gt;;</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">randomKey</span>(<span class="params">cpuEntropyBits?: number </span>): <span class="title">Promise</span>&lt;<span class="title">string</span>&gt;;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h4 id="优化-2020-02-21-15-14-56"><a href="#优化-2020-02-21-15-14-56" class="headerlink" title="优化(2020-02-21 15:14:56)"></a>优化(2020-02-21 15:14:56)</h4><ul>
<li>上述第二点中,使用ts-node需要加上ts-ignore,而直接使用tsc编译为什么能过呢?</li>
<li>原来在tsconfig.json中,我使用include属性将其声明文件包含到编译中了,故可使用.查看ts-node文档,只需要在执行ts-node 加上–files选项,这样将会加载tcconfig.json的include属性,这样就移除ts-ignore这个选项了</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>  最开始自己写*.d.ts,后续发现了居然还有dts-gen这样的工具.回头想想,利用这些工具,真香 ^0^,</p>
<h4 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h4><p>区块链技术痴迷的程序猿一枚，如果你喜欢我的文章，可以加上微信共同学习，共同进步。<br>email: <a href="mailto:&#x73;&#x6b;&#x75;&#110;&#110;&#121;&#x40;&#x31;&#54;&#x33;&#x2e;&#x63;&#x6f;&#109;" target="_blank" rel="noopener">&#x73;&#x6b;&#x75;&#110;&#110;&#121;&#x40;&#x31;&#54;&#x33;&#x2e;&#x63;&#x6f;&#109;</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/07/electron开发记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/07/electron开发记录/" itemprop="url">create-react-app + electron开发桌面版应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-07T19:26:50+08:00">
                2019-09-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h5><p>使用create-react-app 来配置electron 并打包,当然不想折腾环境的可以直接使用<br><a href="https://github.com/electron-react-boilerplate/electron-react-boilerplate" target="_blank" rel="noopener">模板</a>来搭建环境呢.我选择了折腾,这里记录其中的关键点</p>
<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol>
<li>使用create-react-app 创建项目</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app react-electron</span><br><span class="line">cd react-electron</span><br><span class="line">npm install electron electron-builder image-size url --save-dev</span><br><span class="line"><span class="comment">// electron基础包</span></span><br><span class="line"><span class="comment">// electron-builder打包工具</span></span><br><span class="line"><span class="comment">// image-size 提供桌面图标的lib</span></span><br><span class="line"><span class="comment">// url electron的文件路径需要的东西</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在public里创建electron.js文件(可以copy官网的,下面是我的最终版本),一定要放在public目录下,因为cra会把这个文件夹的文件复制到build目录下的呢</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> electron = <span class="built_in">require</span>(<span class="string">'electron'</span>);</span><br><span class="line"><span class="keyword">const</span> platform = <span class="built_in">require</span>(<span class="string">'os'</span>).platform(); <span class="comment">// 获取平台：https://nodejs.org/api/os.html#os_os_platform</span></span><br><span class="line"><span class="comment">// 控制app生命周期.</span></span><br><span class="line"><span class="keyword">const</span> app = electron.app;</span><br><span class="line"><span class="comment">// 浏览器窗口.</span></span><br><span class="line"><span class="keyword">const</span> BrowserWindow = electron.BrowserWindow;</span><br><span class="line"><span class="keyword">const</span> Menu = electron.Menu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">const</span> ipc = electron.ipcMain</span><br><span class="line"><span class="keyword">let</span> mainWindow;</span><br><span class="line"></span><br><span class="line">ipc.on(<span class="string">'app close window'</span>, (sys, msg) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(sys, msg)</span><br><span class="line">    mainWindow.close()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(platform);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> setupMenu = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> menu = <span class="keyword">new</span> Menu();</span><br><span class="line">    mainWindow.setMenu(menu);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> template = [&#123;</span><br><span class="line">        label: <span class="string">"Application"</span>,</span><br><span class="line">        submenu: [&#123;</span><br><span class="line">            label: <span class="string">"About Application"</span>,</span><br><span class="line">            selector: <span class="string">"orderFrontStandardAboutPanel:"</span></span><br><span class="line">        &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                type: <span class="string">"separator"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Quit"</span>,</span><br><span class="line">                accelerator: <span class="string">"Command+Q"</span>,</span><br><span class="line">                click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    quit();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        label: <span class="string">"Edit"</span>,</span><br><span class="line">        submenu: [&#123;</span><br><span class="line">            label: <span class="string">"Undo"</span>,</span><br><span class="line">            accelerator: <span class="string">"CmdOrCtrl+Z"</span>,</span><br><span class="line">            selector: <span class="string">"undo:"</span></span><br><span class="line">        &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Redo"</span>,</span><br><span class="line">                accelerator: <span class="string">"Shift+CmdOrCtrl+Z"</span>,</span><br><span class="line">                selector: <span class="string">"redo:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                type: <span class="string">"separator"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Cut"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+X"</span>,</span><br><span class="line">                selector: <span class="string">"cut:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Copy"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+C"</span>,</span><br><span class="line">                selector: <span class="string">"copy:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Paste"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+V"</span>,</span><br><span class="line">                selector: <span class="string">"paste:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Select All"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+A"</span>,</span><br><span class="line">                selector: <span class="string">"selectAll:"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    Menu.setApplicationMenu(Menu.buildFromTemplate(template));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWindow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个浏览器窗口.</span></span><br><span class="line">    mainWindow = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">        width: <span class="number">800</span>,</span><br><span class="line">        height: <span class="number">600</span>,</span><br><span class="line">        webPreferences: &#123;</span><br><span class="line">            nodeIntegration: <span class="literal">true</span>,  <span class="comment">//允许使用node的方式引入</span></span><br><span class="line">            webSecurity: <span class="literal">false</span>, <span class="comment">// 允许使用本地资源</span></span><br><span class="line">        &#125;,</span><br><span class="line">        backgroundColor: <span class="string">'#B1FF9D'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里要注意一下，这里是让浏览器窗口加载网页。</span></span><br><span class="line">    <span class="comment">// 如果是开发环境，则url为http://localhost:3000（package.json中配置）</span></span><br><span class="line">    <span class="comment">// 如果是生产环境，则url为build/index.html</span></span><br><span class="line">    <span class="keyword">const</span> startUrl = process.env.ELECTRON_START_URL || url.format(&#123;</span><br><span class="line">        pathname: path.join(__dirname, <span class="string">'/../build/index.html'</span>),</span><br><span class="line">        protocol: <span class="string">'file:'</span>,</span><br><span class="line">        slashes: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    setupMenu()</span><br><span class="line">    <span class="comment">// 加载网页之后，会创建`渲染进程`</span></span><br><span class="line">    mainWindow.loadURL(startUrl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开chrome浏览器开发者工具.</span></span><br><span class="line">    <span class="keyword">if</span> (startUrl.startsWith(<span class="string">'http'</span>)) &#123;</span><br><span class="line">        mainWindow.webContents.openDevTools();</span><br><span class="line">    &#125;</span><br><span class="line">    mainWindow.webContents.openDevTools();</span><br><span class="line">    mainWindow.on(<span class="string">'closed'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        mainWindow = <span class="literal">null</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'ready'</span>, createWindow);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'window-all-closed'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.platform !== <span class="string">'darwin'</span>) &#123;</span><br><span class="line">        app.quit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'activate'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mainWindow === <span class="literal">null</span>) &#123;</span><br><span class="line">        createWindow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>修改package.json  main字段修改的是程序的入口, build为electron-builder的打包的一些配置</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"main"</span>: <span class="string">"./public/electron.js"</span>,</span><br><span class="line"><span class="string">"homepage"</span>: <span class="string">"."</span>,</span><br><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"start"</span>: <span class="string">"react-scripts start"</span>,</span><br><span class="line">  <span class="string">"build"</span>: <span class="string">"react-scripts build"</span>,</span><br><span class="line">  <span class="string">"test"</span>: <span class="string">"react-scripts test"</span>,</span><br><span class="line">  <span class="string">"eject"</span>: <span class="string">"react-scripts eject"</span>,</span><br><span class="line">  <span class="string">"electron"</span>: <span class="string">"electron ."</span>,</span><br><span class="line">  <span class="string">"electron-dev"</span>: <span class="string">"ELECTRON_START_URL=http://localhost:3000/ electron ."</span>,</span><br><span class="line">  <span class="string">"packager"</span>: <span class="string">"npm run build &amp;&amp; rm -rf dist &amp;&amp; electron-builder --mac"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"build"</span>: &#123;</span><br><span class="line">  <span class="string">"productName"</span>: <span class="string">"example"</span>,</span><br><span class="line">  <span class="string">"appId"</span>: <span class="string">"com.example.server"</span>,</span><br><span class="line">  <span class="string">"files"</span>: [</span><br><span class="line">    <span class="string">"build/**/*"</span>,</span><br><span class="line">    <span class="string">"package.json"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"directories"</span>: &#123;</span><br><span class="line">    <span class="string">"buildResources"</span>: <span class="string">"public"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>npm start 启动react项目</li>
<li>npm run electron-dev 启动electron项目  </li>
<li>npm run build 打包react项目</li>
<li>npm run electron 查看react打包的结果</li>
<li>npm run package 打包mac应用(win需要再配置一下)</li>
</ol>
<h5 id="结果演示"><a href="#结果演示" class="headerlink" title="结果演示"></a>结果演示</h5><p><a href="https://github.com/shaokun11/react-electron" target="_blank" rel="noopener">源码</a><br><img src="/react/react-electron.gif" alt="material-ui self host font"> </p>
<h5 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h5><p>区块链技术痴迷的程序猿一枚，如果你喜欢我的文章，可以加上微信共同学习，共同进步。  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">shaokun</p>
              <p class="site-description motion-element" itemprop="description">记录自己对相关技术的点点滴滴和一些思考，希望能够帮助来到这里的你，如果你喜欢我的文章，可以加个微信共同探讨</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shaokun</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
 <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
