<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="è®°å½•è‡ªå·±å¯¹ç›¸å…³æŠ€æœ¯çš„ç‚¹ç‚¹æ»´æ»´å’Œä¸€äº›æ€è€ƒï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©æ¥åˆ°è¿™é‡Œçš„ä½ ï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸ªå¾®ä¿¡å…±åŒæ¢è®¨">
<meta name="keywords" content="eos,eth,tron,åŒºå—é“¾">
<meta property="og:type" content="website">
<meta property="og:title" content="hello shaokun">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="hello shaokun">
<meta property="og:description" content="è®°å½•è‡ªå·±å¯¹ç›¸å…³æŠ€æœ¯çš„ç‚¹ç‚¹æ»´æ»´å’Œä¸€äº›æ€è€ƒï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©æ¥åˆ°è¿™é‡Œçš„ä½ ï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸ªå¾®ä¿¡å…±åŒæ¢è®¨">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hello shaokun">
<meta name="twitter:description" content="è®°å½•è‡ªå·±å¯¹ç›¸å…³æŠ€æœ¯çš„ç‚¹ç‚¹æ»´æ»´å’Œä¸€äº›æ€è€ƒï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©æ¥åˆ°è¿™é‡Œçš„ä½ ï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸ªå¾®ä¿¡å…±åŒæ¢è®¨">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>hello shaokun</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hello shaokun</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">code is law</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/15/graphqlæ„å»ºæœåŠ¡/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/15/graphqlæ„å»ºæœåŠ¡/" itemprop="url">koa + graphqlçš„ä½¿ç”¨(2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-15T22:35:14+08:00">
                2020-11-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h4><blockquote>
<p><a href="https://shaokun11.github.io/2020/08/16/koa+graphql%E5%AE%9A%E4%B9%89%E4%BD%A0%E7%9A%84%E6%8E%A5%E5%8F%A3/" target="_blank" rel="noopener">koa + graphqlçš„ä½¿ç”¨</a>åœ¨è¿™ç¯‡æ–‡ç« ä¸­,æˆ‘ä»¬åªå®ç°äº†åŸºæœ¬ä¸Šçš„å¦‚ä½•ä½¿ç”¨graphql,é‚£ä¹ˆæˆ‘ä»¬æ¥å®ç°ä¸šåŠ¡ä¸Šçš„graphql</p>
</blockquote>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><ul>
<li>ç›®å½•ç»“æ„,å¤§ä½“ä¸Šåˆ†ä¸ºä¸‰ä¸ªç›®å½•ç»“æ„,schemaç”¨äºå®šäºæ‰€æœ‰çš„ç±»å‹,resolverå®šä¹‰ç›¸åº”ç±»å‹çš„å®ç°,modelså®šä¹‰ä¸€äº›serviceçš„å…·ä½“å®ç°,å¦‚æŸ¥è¯¢æ•°æ®åº“,app.tsä¸ºé¡¹ç›®å…¥å£</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./src:</span><br><span class="line">app.ts		models		resolvers	schema</span><br><span class="line"></span><br><span class="line">./src/models:</span><br><span class="line">index.ts</span><br><span class="line"></span><br><span class="line">./src/resolvers:</span><br><span class="line">index.ts	message.ts	user.ts</span><br><span class="line"></span><br><span class="line">./src/schema:</span><br><span class="line">index.ts	message.ts	user.ts</span><br></pre></td></tr></table></figure>
<ul>
<li>é¡¹ç›®å…¥å£app.ts,å¯ä»¥çœ‹åˆ°å’Œä¸Šè¯‰å®šä¹‰çš„ç›®å½•ç»“æ„ä¸€è‡´,å¼•å…¥æ ¹æ•°æ®,æ³¨æ„å…¶ä¸­çš„context,è¿™é‡Œç”¨äºæŒ‚åœ¨æŒ‚è½½å…¨å±€å˜é‡,å®ç°ä¸€äº›ä¸­é—´ä»¶çš„æŒ‚è½½,å¦‚auth</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Koa <span class="keyword">from</span> <span class="string">"koa"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApolloServer &#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line"><span class="keyword">import</span> resolvers <span class="keyword">from</span> <span class="string">"./resolvers"</span>;</span><br><span class="line"><span class="keyword">import</span> typeDefs <span class="keyword">from</span> <span class="string">"./schema"</span>;</span><br><span class="line"><span class="keyword">import</span> models <span class="keyword">from</span> <span class="string">"./models"</span>;</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context: &#123;</span><br><span class="line">    models,</span><br><span class="line">    me: models.users[<span class="number">1</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: <span class="number">5000</span> &#125;, () =&gt;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`ğŸš€ Server ready at http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ul>
<li>å®šä¹‰userçš„schema,æ³¨æ„å…¶ä¸­çš„queryåŠ ä¸Šäº†extendå­—æ®µ(message.tså†…å®¹ä¸€è‡´)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;gql&#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = gql<span class="string">`</span></span><br><span class="line"><span class="string">    extend type Query &#123;</span></span><br><span class="line"><span class="string">        users: [User!]</span></span><br><span class="line"><span class="string">        user(id: ID!): User</span></span><br><span class="line"><span class="string">        me: String!</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    type User &#123;</span></span><br><span class="line"><span class="string">        id: ID!</span></span><br><span class="line"><span class="string">        username: String!</span></span><br><span class="line"><span class="string">        messages: [Message!]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> User;</span><br><span class="line"><span class="string">``</span><span class="string">`   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-	å®šä¹‰schemaçš„å¯¼å‡ºæ–‡ä»¶,å®šä¹‰ç©ºçš„schema,ä»¥ä¾¿å…·ä½“çš„å®ä½“å¯ä»¥ç»§æ‰¿,å›ºå®šå†™æ³•</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascritp</span><br><span class="line">	<span class="keyword">import</span> &#123; gql &#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line">	<span class="keyword">import</span> message <span class="keyword">from</span> <span class="string">"./message"</span>;</span><br><span class="line">	<span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">"./user"</span>;</span><br><span class="line">	<span class="keyword">const</span> linkSchema = gql<span class="string">`</span></span><br><span class="line"><span class="string">	  type Query &#123;</span></span><br><span class="line"><span class="string">	    _: Boolean</span></span><br><span class="line"><span class="string">	  &#125;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	  type Mutation &#123;</span></span><br><span class="line"><span class="string">	    _: Boolean</span></span><br><span class="line"><span class="string">	  &#125;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	  type Subscription &#123;</span></span><br><span class="line"><span class="string">	    _: Boolean</span></span><br><span class="line"><span class="string">	  &#125;</span></span><br><span class="line"><span class="string">	`</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">export</span> <span class="keyword">default</span> [linkSchema, user, message];</span><br></pre></td></tr></table></figure>
<ul>
<li>userçš„resolverå…·ä½“å®ç°,æ ¹æ®userçš„schemaå®ç°,è¿™é‡Œæ³¨æ„resolveræ¥æ”¶å››ä¸ªå‚æ•°,æ ¹æ®å®˜ç½‘çš„è¯´æ³•,æˆ‘ä»¬ä¸€èˆ¬ç”¨ä¸Šå‰ä¸‰ä¸ªå°±å¤Ÿäº†,</li>
</ul>
<ul>
<li>åˆ†åˆ«æ˜¯parent,å³ä¸Šä¸€ä¸ªæŸ¥è¯¢çš„çš„ç»“æœ</li>
<li>args,æœ¬æ¬¡æ‰§è¡Œçš„å‰ç«¯é¡µé¢ä¼ è¿‡æ¥çš„å‚æ•°</li>
<li>context,å³appä¸­çš„context,å³è¿”å›çš„é‚£ä¸ªobject</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;IResolvers&#125; <span class="keyword">from</span> <span class="string">"apollo-server-koa"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user: IResolvers = &#123;</span><br><span class="line">	Query: &#123;</span><br><span class="line">		users: <span class="function">(<span class="params">parent, args, &#123;models&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">Object</span>.values(models.users);</span><br><span class="line">		&#125;,</span><br><span class="line">		user: <span class="function">(<span class="params">parent, &#123;id&#125;, &#123;models&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> models.users[id];</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">	User: &#123;</span><br><span class="line">		messages: <span class="function">(<span class="params">user, args, &#123;models&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">Object</span>.values(models.messages).filter(</span><br><span class="line">				<span class="comment">//@ts-ignore</span></span><br><span class="line">				(message) =&gt; message.userId === user.id</span><br><span class="line">			);</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> user;</span><br></pre></td></tr></table></figure>
<ul>
<li>resolver å¯¼å‡ºæ–‡ä»¶,ç›´æ¥å¯¼å‡ºæ•°ç»„å³å¯  </li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> message <span class="keyword">from</span> <span class="string">"./message"</span>;</span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">"./user"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [message, user];</span><br></pre></td></tr></table></figure>
<ul>
<li>models æ¨¡æ‹Ÿæœ¬æ¬¡ç¨‹åºçš„æ•°æ®,ç°å®ä¸­ç”¨æ•°æ®åº“ä»£æ›¿å³å¯</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> users = &#123;</span><br><span class="line">  <span class="number">1</span>: &#123;</span><br><span class="line">    id: <span class="string">"1"</span>,</span><br><span class="line">    username: <span class="string">"hello shoakun 1"</span>,</span><br><span class="line">    messageIds: [<span class="number">1</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">2</span>: &#123;</span><br><span class="line">    id: <span class="string">"2"</span>,</span><br><span class="line">    username: <span class="string">"hello shaokun2"</span>,</span><br><span class="line">    messageIds: [<span class="number">2</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> messages = &#123;</span><br><span class="line">  <span class="number">1</span>: &#123;</span><br><span class="line">    id: <span class="string">"1"</span>,</span><br><span class="line">    text: <span class="string">"Hello World"</span>,</span><br><span class="line">    userId: <span class="string">"1"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="number">2</span>: &#123;</span><br><span class="line">    id: <span class="string">"2"</span>,</span><br><span class="line">    text: <span class="string">"By World"</span>,</span><br><span class="line">    userId: <span class="string">"2"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  users,</span><br><span class="line">  messages,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="ç»“æœæ¼”ç¤º"><a href="#ç»“æœæ¼”ç¤º" class="headerlink" title="ç»“æœæ¼”ç¤º"></a>ç»“æœæ¼”ç¤º</h5><p><a href="https://github.com/shaokun11/gql-server" target="_blank" rel="noopener">æºç </a><br><img src="/react/graphql2.gif" alt="graphql query demo"> </p>
<h5 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h5><p>åŒºå—é“¾æŠ€æœ¯ç—´è¿·çš„ç¨‹åºçŒ¿ä¸€æšï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸Šå¾®ä¿¡å…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/08/uniswap æºç è§£è¯»6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/08/uniswap æºç è§£è¯»6/" itemprop="url">ä¸€æ­¥ä¸€æ­¥æ•™ä½ æ‰“é€ è‡ªå·±çš„defi-xswap(6)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-08T17:10:49+08:00">
                2020-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦é…åˆå‰ç«¯å®ç°xswapçš„æœ€åä¸€ä¸ªåŠŸèƒ½swap</p>
</blockquote>
<h4 id="swapå…¬å¼"><a href="#swapå…¬å¼" class="headerlink" title="swapå…¬å¼"></a>swapå…¬å¼</h4><ul>
<li>æ­¤å…¬å¼ç”± UniswapV2Libraryæä¾›</li>
<li>getAmountOut å³æˆ‘ä»˜å‡ºä¸€å®šé‡çš„token,å¯ä»¥å¾—åˆ°å¦ä¸€ç§tokençš„å¤šå°‘,æ¯”å¦‚æˆ‘åªæœ‰100ä¸ªtokenA,è¿™ä¸ªå°±æ˜¯æŸ¥çœ‹æˆ‘è¿™ä¸ª100tokenAå¯ä»¥æ¢å–åˆ°å¤šå°‘ä¸ªtokenB</li>
<li>getAmountIn, å³æˆ‘è¦å¾—åˆ°ä¸€å®šé‡çš„token,æˆ‘å¾—ä»˜å‡ºå¤šå°‘å¦ä¸€ç§token,æ¯”å¦‚æˆ‘æƒ³è¦100ä¸ªtokenA,é‚£ä¹ˆè¿™ä¸ªå°±æ˜¯æŸ¥çœ‹æˆ‘è¦ä»˜å‡ºå¤šå°‘ä¸ªtokenB</li>
<li>æ¯æ¬¡äº¤æ˜“,å‡æœ‰åƒåˆ†ä¹‹ä¸‰fromTokençš„æŸå¤±,è¿™éƒ¨åˆ†è´¹ç”¨æ˜¯æŒ‰ç…§LPçš„æ¯”ä¾‹åˆ†ç»™æä¾›LPçš„åšå¸‚å•†</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAmountOut</span>(<span class="params">uint amountIn, uint reserveIn, uint reserveOut</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint amountOut</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">require</span>(amountIn &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT'</span>);</span><br><span class="line">      <span class="built_in">require</span>(reserveIn &gt; <span class="number">0</span> &amp;&amp; reserveOut &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_LIQUIDITY'</span>);</span><br><span class="line">      uint amountInWithFee = amountIn.mul(<span class="number">997</span>);</span><br><span class="line">      uint numerator = amountInWithFee.mul(reserveOut);</span><br><span class="line">      uint denominator = reserveIn.mul(<span class="number">1000</span>).add(amountInWithFee);</span><br><span class="line">      amountOut = numerator / denominator;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// given an output amount of an asset and pair reserves, returns a required input amount of the other asset</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAmountIn</span>(<span class="params">uint amountOut, uint reserveIn, uint reserveOut</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint amountIn</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">require</span>(amountOut &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_OUTPUT_AMOUNT'</span>);</span><br><span class="line">      <span class="built_in">require</span>(reserveIn &gt; <span class="number">0</span> &amp;&amp; reserveOut &gt; <span class="number">0</span>, <span class="string">'UniswapV2Library: INSUFFICIENT_LIQUIDITY'</span>);</span><br><span class="line">      uint numerator = reserveIn.mul(amountOut).mul(<span class="number">1000</span>);</span><br><span class="line">      uint denominator = reserveOut.sub(amountOut).mul(<span class="number">997</span>);</span><br><span class="line">      amountIn = (numerator / denominator).add(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="demoéªŒè¯"><a href="#demoéªŒè¯" class="headerlink" title="demoéªŒè¯"></a>demoéªŒè¯</h4><ul>
<li><a href="https://github.com/shaokun11/xswap/tree/v4" target="_blank" rel="noopener">æœ¬æ¬¡æ¼”ç¤ºå‰ç«¯ä»£ç </a></li>
<li>ç›®å‰æœ‰ä¸¤æ­¥æ“ä½œ,ä¸€æ˜¯è½¬å…¥tokenAåˆ°pairä¸­,äºŒæ˜¯æ ¹æ®ä¸Šè¿°çš„ç®—æ³•,åŠ¨æ€è®¡ç®—å‡ºtokenAè½¬å…¥å¯ä»¥å¾—åˆ°çš„tokenBçš„æ•°é‡,è°ƒç”¨pairçš„swapæ–¹æ³•å°†tokenBæåˆ°è‡ªå·±çš„é’±åŒ…ä¸­</li>
<li>å‰ç«¯éœ€ä½¿ç”¨bignumber.jsè¿™ä¸ªlibæ¥è®¡ç®—å¤§æ•°,å¯ä»¥çœ‹åˆ°å’Œåˆçº¦çš„å®ç°æ˜¯ä¸€æ ·çš„,åªæœ‰è¿™æ ·æ‰èƒ½é€šè¿‡éªŒè¯  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import BN from &apos;bignumber.js&apos;</span><br><span class="line">function getAmountIn(amountOut: string, reserveIn: string, reserveOut) &#123;</span><br><span class="line">    return new BN(&apos;1000&apos;)</span><br><span class="line">        .times(amountOut)</span><br><span class="line">        .times(reserveIn)</span><br><span class="line">        .div(new BN(reserveOut).minus(amountOut).times(997).plus(1))</span><br><span class="line">        .toFixed()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getAmountOut(amountIn: string, reserveIn: string, reserveOut: string) &#123;</span><br><span class="line">    let feeIn = new BN(amountIn).times(997)</span><br><span class="line">    return feeIn</span><br><span class="line">        .times(reserveOut)</span><br><span class="line">        .div(feeIn.plus(new BN(1000).times(reserveIn)))</span><br><span class="line">        .toFixed()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/xswap/ether7.gif" alt="xswap">  </p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul>
<li>xswapåˆ°è¿™é‡Œå·²ç»ç»“æŸäº†.</li>
<li>æœ¬ç³»åˆ—åªé‡ç‚¹ç€é‡äºåˆçº¦ä»£ç å±‚é¢çš„å®ç°,é‡‡ç”¨reactå…¨å®¶æ¡¶å®ç°çš„å‰ç«¯ç•Œé¢(æ–‡ä¸­åšè¿‡å¤šä»‹ç»å‰ç«¯ä»£ç çš„å®ç°).</li>
<li>ä¸ªäººè§‰å¾—uniswapçš„ç²¾é«“åœ¨å…¶æ•´ä¸ªçš„è®¾è®¡ä¸å…¶åˆ›æ–°,ç†è®ºä¸Šæ¥è®²,æ˜¯çœŸæ­£å®ç°äº†ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„äº¤æ˜“æ‰€çš„åŠŸèƒ½</li>
<li>ç›®å‰å‰ç«¯é¡µé¢åªæä¾›äº†tokenA,ä¸tokenBçš„æ“ä½œ,ä¸”åªé€‚ç”¨äºrinkebyç½‘ç»œ,å¦‚æœå„ä½åŒå­¦æƒ³è¦è¿›ä¸€æ­¥å‘æŒ¥,å¯ä»¥å®Œå…¨å‚è€ƒuniswapçš„å®ç°<a href="https://github.com/Uniswap/uniswap-v2-periphery" target="_blank" rel="noopener">uniswap-peripher</a>,<a href="https://github.com/Uniswap/uniswap-interface" target="_blank" rel="noopener">uniswapå‰ç«¯é¡µé¢</a>è‡ªå·±å®ç°ä¸€å¥—å±äºè‡ªå·±çš„swapå§</li>
</ul>
<h4 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h4><p>åŒºå—é“¾ç¨‹åºçŒ¿ä¸€æš<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/07/uniswap æºç è§£è¯»5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/07/uniswap æºç è§£è¯»5/" itemprop="url">ä¸€æ­¥ä¸€æ­¥æ•™ä½ æ‰“é€ è‡ªå·±çš„defi-xswap(5)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-07T19:05:23+08:00">
                2020-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»UniswapV2Pairä¸­çš„ä»¥åŠä¸€ä¸ªåè¯,ä¸‰ä¸ªæ–¹æ³•,å››ä¸ªå˜é‡,ç†è§£å®Œå,å®ç°xswapçš„add,removeçš„åŠŸèƒ½</p>
</blockquote>
<h4 id="ä¸€ä¸ªåè¯"><a href="#ä¸€ä¸ªåè¯" class="headerlink" title="ä¸€ä¸ªåè¯"></a>ä¸€ä¸ªåè¯</h4><ul>
<li>liquidity (LP)æµåŠ¨æ€§,å³pairçš„tokençš„æ•°é‡,ä»£è¡¨ç€ä½ æ‰€æœ‰è¿™ä¸ªpairä»·å€¼çš„é‡,å…¶ä»·å€¼ä¸ºä½ çš„LPå æ€»LPçš„ç™¾åˆ†æ¯”ä¹˜ä»¥pairçš„æ€»ä»·å€¼</li>
</ul>
<h4 id="å››ä¸ªå˜é‡"><a href="#å››ä¸ªå˜é‡" class="headerlink" title="å››ä¸ªå˜é‡"></a>å››ä¸ªå˜é‡</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">address public token0;			//	äº¤æ˜“å¯¹ä¸­çš„token0 çš„åœ°å€</span><br><span class="line">address public token1;			// äº¤æ˜“å¯¹ä¸­çš„token1 çš„åœ°å€</span><br><span class="line">uint112 private reserve0;    // äº¤æ˜“å¯¹åœ°å€ä¸­çš„ token0çš„æ•°é‡,å³token0çš„ä»·å€¼    </span><br><span class="line">uint112 private reserve1; 	// äº¤æ˜“å¯¹åœ°å€ä¸­çš„ token1çš„æ•°é‡ ,å³token1çš„ä»·å€¼</span><br></pre></td></tr></table></figure>
<h4 id="ä¸‰ä¸ªæ–¹æ³•"><a href="#ä¸‰ä¸ªæ–¹æ³•" class="headerlink" title="ä¸‰ä¸ªæ–¹æ³•"></a>ä¸‰ä¸ªæ–¹æ³•</h4><ul>
<li>mint å³ç”Ÿäº§LP,å…¶è§„åˆ™æ ¹æ®ä½ å‘è¿™ä¸ªpairä¸­æŒ‰ç…§<strong>å›ºå®šæ¯”ä¾‹(ç¬¬ä¸€ç¬”è®¾å®šæ¯”ä¾‹)</strong>è½¬å…¥ä¸€å®šæ•°é‡token0,token1.å½“ç„¶ä½ å¯ä»¥ä¸æŒ‰ç…§è¿™ä¸ªæ¯”ä¾‹è½¬å…¥,ä½†æ˜¯ä½ å¾—åˆ°çš„LPæ˜¯æŒ‰ç…§è¿™ä¸ªæ¯”ä¾‹ä¸­çš„å°çš„ç»™ä½ ç®—çš„,æ‰€ä»¥ä¸è¦åšè¿™æ ·çš„äº‹å‘¢</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function mint(address to) external lock returns (uint liquidity) &#123;</span><br><span class="line">    (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">    uint balance0 = IERC20(token0).balanceOf(address(this));</span><br><span class="line">    uint balance1 = IERC20(token1).balanceOf(address(this));</span><br><span class="line">    uint amount0 = balance0.sub(_reserve0);</span><br><span class="line">    uint amount1 = balance1.sub(_reserve1);</span><br><span class="line">    bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">    uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">    if (_totalSupply == 0) &#123;</span><br><span class="line">        liquidity = Math.sqrt(amount0.mul(amount1)).sub(MINIMUM_LIQUIDITY);</span><br><span class="line">       _mint(address(0), MINIMUM_LIQUIDITY); // permanently lock the first MINIMUM_LIQUIDITY tokens</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        liquidity = Math.min(amount0.mul(_totalSupply) / _reserve0, amount1.mul(_totalSupply) / _reserve1);</span><br><span class="line">    &#125;</span><br><span class="line">    require(liquidity &gt; 0, &apos;UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED&apos;);</span><br><span class="line">    _mint(to, liquidity);</span><br><span class="line"></span><br><span class="line">    _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">    if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">    emit Mint(msg.sender, amount0, amount1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>burn å³é”€æ¯ä½ è½¬å…¥çš„LP,å³ä½ å…ˆæŠŠLPè½¬å…¥pairåˆçº¦ä¸­,ç„¶åæ ¹æ®ä½ è½¬å…¥çš„LPæ•°é‡æŒ‰ç…§å æ€»é‡LPçš„æ¯”ä¾‹è¿”å›pairä¸­token0,token1åˆ°ä½ æŒ‡å®šçš„åœ°å€</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">burn</span>(<span class="params">address to</span>) <span class="title">external</span> <span class="title">lock</span> <span class="title">returns</span> (<span class="params">uint amount0, uint amount1</span>) </span>&#123;</span><br><span class="line">      (uint112 _reserve0, uint112 _reserve1,) = getReserves(); <span class="comment">// gas savings</span></span><br><span class="line">      address _token0 = token0;                                <span class="comment">// gas savings</span></span><br><span class="line">      address _token1 = token1;                                <span class="comment">// gas savings</span></span><br><span class="line">      uint balance0 = IERC20(_token0).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">      uint balance1 = IERC20(_token1).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">      uint liquidity = balanceOf[address(<span class="keyword">this</span>)];</span><br><span class="line">      bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">      uint _totalSupply = totalSupply; <span class="comment">// gas savings, must be defined here since totalSupply can update in _mintFee</span></span><br><span class="line">      amount0 = liquidity.mul(balance0) / _totalSupply; <span class="comment">// using balances ensures pro-rata distribution</span></span><br><span class="line">      amount1 = liquidity.mul(balance1) / _totalSupply; <span class="comment">// using balances ensures pro-rata distribution</span></span><br><span class="line">      <span class="built_in">require</span>(amount0 &gt; <span class="number">0</span> &amp;&amp; amount1 &gt; <span class="number">0</span>, <span class="string">'UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED'</span>);</span><br><span class="line">      _burn(address(<span class="keyword">this</span>), liquidity);</span><br><span class="line">      _safeTransfer(_token0, to, amount0);</span><br><span class="line">      _safeTransfer(_token1, to, amount1);</span><br><span class="line">      balance0 = IERC20(_token0).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">      balance1 = IERC20(_token1).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">      _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">      <span class="keyword">if</span> (feeOn) kLast = uint(reserve0).mul(reserve1); <span class="comment">// reserve0 and reserve1 are up-to-date</span></span><br><span class="line">      emit Burn(msg.sender, amount0, amount1, to);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>swap å³ä½¿ç”¨token0äº¤æ¢token1æˆ–è€…ç›¸åäº¤æ˜“.æ³¨æ„ä¸€ä¸‹,swapæ˜¯ä¸ä¼šæ”¹å˜pairçš„LPçš„é‡.è¿™ä¸ªå‘¢ä¼šæ”¹å˜å½“å‰ä¸¤ç§tokenå¯¹åº”çš„ä»·æ ¼.æ‰€ä»¥ä¸€ä¸ªtokençš„ä»·æ ¼ä¹Ÿå³æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å®šä¹‰çš„å‘¢!</p>
</li>
<li>è¿™é‡Œå…·ä½“çš„æ“ä½œå‘¢?è¿™é‡Œè®¾è®¡å¾—éå¸¸å·§å¦™!</li>
<li><em>function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external lock </em> å‡½æ•°ç­¾åä¸­,amount0Outä¸amount1Outä¸€å®šæœ‰ä¸€ä¸ªå€¼ä¸º0,æ‰€ä»¥é¦–å…ˆå¾—è½¬å…¥ä½ éœ€è¦äº¤æ˜“çš„å–æ‰çš„token,å¦‚æœæ˜¯token0,é‚£ä¹ˆè°ƒç”¨æ­¤æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°å³amount1Outè®¾ç½®ä¸ºå¤§äº0çš„å€¼å³å¯å¾—åˆ°ä½ æƒ³è¦çš„å¦ä¸€ç§token,å³å®Œæˆäº†ä¸€æ¬¡äº¤æ˜“,è‡³äºè¿™ä¸ªå€¼å¡«å¤šå°‘? å€¼ä¸ºç†è®ºè½¬å‡ºçš„99.7%</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">swap</span>(<span class="params">uint amount0Out, uint amount1Out, address to, bytes calldata data</span>) <span class="title">external</span> <span class="title">lock</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(amount0Out &gt; <span class="number">0</span> || amount1Out &gt; <span class="number">0</span>, <span class="string">'UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT'</span>);</span><br><span class="line">    (uint112 _reserve0, uint112 _reserve1,) = getReserves(); <span class="comment">// gas savings</span></span><br><span class="line">    <span class="built_in">require</span>(amount0Out &lt; _reserve0 &amp;&amp; amount1Out &lt; _reserve1, <span class="string">'UniswapV2: INSUFFICIENT_LIQUIDITY'</span>);</span><br><span class="line"></span><br><span class="line">    uint balance0;</span><br><span class="line">    uint balance1;</span><br><span class="line">    &#123; <span class="comment">// scope for _token&#123;0,1&#125;, avoids stack too deep errors</span></span><br><span class="line">    address _token0 = token0;</span><br><span class="line">    address _token1 = token1;</span><br><span class="line">    <span class="built_in">require</span>(to != _token0 &amp;&amp; to != _token1, <span class="string">'UniswapV2: INVALID_TO'</span>);</span><br><span class="line">    <span class="keyword">if</span> (amount0Out &gt; <span class="number">0</span>) _safeTransfer(_token0, to, amount0Out); <span class="comment">// optimistically transfer tokens</span></span><br><span class="line">    <span class="keyword">if</span> (amount1Out &gt; <span class="number">0</span>) _safeTransfer(_token1, to, amount1Out); <span class="comment">// optimistically transfer tokens</span></span><br><span class="line">    <span class="keyword">if</span> (data.length &gt; <span class="number">0</span>) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);</span><br><span class="line">    balance0 = IERC20(_token0).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">    balance1 = IERC20(_token1).balanceOf(address(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    uint amount0In = balance0 &gt; _reserve0 - amount0Out ? balance0 - (_reserve0 - amount0Out) : <span class="number">0</span>;</span><br><span class="line">    uint amount1In = balance1 &gt; _reserve1 - amount1Out ? balance1 - (_reserve1 - amount1Out) : <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">require</span>(amount0In &gt; <span class="number">0</span> || amount1In &gt; <span class="number">0</span>, <span class="string">'UniswapV2: INSUFFICIENT_INPUT_AMOUNT'</span>);</span><br><span class="line">    &#123; <span class="comment">// scope for reserve&#123;0,1&#125;Adjusted, avoids stack too deep errors</span></span><br><span class="line">    uint balance0Adjusted = balance0.mul(<span class="number">1000</span>).sub(amount0In.mul(<span class="number">3</span>));</span><br><span class="line">    uint balance1Adjusted = balance1.mul(<span class="number">1000</span>).sub(amount1In.mul(<span class="number">3</span>));</span><br><span class="line">    <span class="built_in">require</span>(balance0Adjusted.mul(balance1Adjusted) &gt;= uint(_reserve0).mul(_reserve1).mul(<span class="number">1000</span>**<span class="number">2</span>), <span class="string">'UniswapV2: K'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">    emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="demoéªŒè¯"><a href="#demoéªŒè¯" class="headerlink" title="demoéªŒè¯"></a>demoéªŒè¯</h4><ul>
<li><a href="https://github.com/shaokun11/xswap/tree/v3" target="_blank" rel="noopener">æœ¬æ¬¡æ¼”ç¤ºå‰ç«¯ä»£ç </a></li>
<li>ç›¸å…³åˆçº¦åœ°å€: factory:<strong>0xfed46C22C2C39126F3312fBe739a0D9cD29AD1D1</strong> tokenA: <strong>0x425CBf6caF564FfFe1629ACADBD17Ee421B1f6aE</strong> tokenB: <strong>0x7A759B6cb32Ba3098530909aD5178dc6125A2c26</strong></li>
<li>ç”±äºæ‰§è¡Œæ·»åŠ æˆ–è€…swapéœ€è¦ä¸€å¯¹token,æ‰€ä»¥é¡ºå¸¦åˆ›å»ºäº†2ä¸ªæµ‹è¯•token,<a href="https://github.com/shaokun11/solidity-env-hardhat/blob/v4/contracts/XToken.sol" target="_blank" rel="noopener">xtokenæ¨¡æ¿</a>æä¾›äº†<em>faucet</em>æ–¹æ³•,æ¯æ¬¡è°ƒç”¨å°†ä¼šç©ºæŠ•100ä¸ªtokenåˆ°æ“ä½œè´¦æˆ·çš„åœ°å€</li>
<li>è¿™é‡Œæˆ‘åˆå§‹å®šä»·ä¸º 2 tokenA = 1 tokenB,</li>
<li>ä½¿ç”¨faucetæ–¹æ³•åˆ†åˆ«å¾—åˆ°ä¸€å®šæ•°é‡çš„tokenA tokenB(è¿™é‡Œåªæ¼”ç¤ºäº†è·å–TokenA)</li>
<li>add è½¬è´¦tokenA éƒ½pairåˆçº¦ä¸­,è½¬è´¦tokenBåˆ°pairåˆçº¦ä¸­,æ¢å–LPåˆ°è‡ªå·±çš„è´¦æˆ· (è¿™é‡Œä¸€å…±æ‰§è¡Œäº†ä¸‰æ¬¡åˆçº¦)</li>
<li>remove è½¬è´¦LPåˆ°pairåˆçº¦ä¸­,å†æ ¹æ®è½¬è¿›å»çš„LPæŒ‰ç…§æ€»çš„æ¯”ä¾‹å–å‡ºæ¢å›æ¥çš„tokenA,tokenB<br><img src="/xswap/ether5.gif" alt="xswap">  </li>
</ul>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul>
<li>æ³¨æ„ä¸€ä¸‹,æœ¬ç³»åˆ—æ‰€æœ‰çš„åˆçº¦ä»…éƒ¨ç½²åœ¨äº†rinkebyæµ‹è¯•é“¾ä¸Š,å¦‚æœéœ€è¦æºç æ¼”ç¤ºè¯·åˆ‡æ¢ç½‘ç»œæ‰</li>
<li>æ­¤åˆçº¦éƒ¨ç½²åªéœ€è¦<a href="https://github.com/Uniswap/uniswap-v2-core/blob/master/contracts/UniswapV2Factory.sol" target="_blank" rel="noopener">UniswapV2Factory.sol</a>è¿™ä¸€ä¸ªåˆçº¦å³å¯,è¿™é‡Œæˆ‘flattenä¸€ä¸‹è¿™ä¸ªåˆçº¦,å„ä½åŒå­¦å¯ä»¥ç›´æ¥ä½¿ç”¨<a href="https://github.com/shaokun11/solidity-env-hardhat/blob/v4/contracts/XSwapFactory.sol" target="_blank" rel="noopener">faltten UniswapV2Factory.sol</a></li>
<li>çœ‹å®Œpariè¿™ä¸ªåˆçº¦,åˆçº¦ä»£ç æ–¹é¢çš„æŠ€æœ¯éš¾é¢˜äº†,æœ¬ç¯‡æ–‡ç« åªå®ç°äº†addçš„åŠŸèƒ½,ä¸‹ä¸€ç¯‡å®ç°å…¶æœ€åä¸€ä¸ªåŠŸèƒ½swap</li>
</ul>
<h4 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h4><p>åŒºå—é“¾ç¨‹åºçŒ¿ä¸€æš<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/02/uniswap æºç è§£è¯»4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/02/uniswap æºç è§£è¯»4/" itemprop="url">ä¸€æ­¥ä¸€æ­¥æ•™ä½ æ‰“é€ è‡ªå·±çš„defi-xswap(4)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-11-02T23:17:23+08:00">
                2020-11-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>æœ¬ç¯‡æ–‡ç« ç¼–å†™æ™ºèƒ½åˆçº¦ä¸­çš„create2çš„ä½¿ç”¨,ä¹Ÿå°±æ˜¯uniswapä¸­çš„<strong>UniswapV2Factory</strong>åˆçº¦ä¸­çš„createPairæ–¹æ³•.å…·ä½“çš„ä¿¡æ¯å¯å‚è€ƒ<a href="https://eips.ethereum.org/EIPS/eip-1014" target="_blank" rel="noopener">eip1014</a>ä¸<a href="https://blog.ricmoo.com/wisps-the-magical-world-of-create2-5c2177027604" target="_blank" rel="noopener">the-magical-world-of-create2</a>.</p>
</blockquote>
<h4 id="create2çš„ä½¿ç”¨æ–¹å¼"><a href="#create2çš„ä½¿ç”¨æ–¹å¼" class="headerlink" title="create2çš„ä½¿ç”¨æ–¹å¼"></a>create2çš„ä½¿ç”¨æ–¹å¼</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bytes memory bytecode = type(UniswapV2Pair).creationCode;</span><br><span class="line">bytes32 salt = keccak256(abi.encodePacked(token0, token1));</span><br><span class="line">    assembly &#123;</span><br><span class="line">         pair := create2(<span class="number">0</span>, add(bytecode, <span class="number">32</span>), mload(bytecode), salt)</span><br><span class="line">   &#125;</span><br><span class="line">     IUniswapV2Pair(pair).initialize(token0, token1);</span><br></pre></td></tr></table></figure>
<ul>
<li>æ­¤å¤„ä¸»è¦æ³¨æ„çœ‹ä»¥ä¸Šä¸¤è¡Œä»£ç ,æŒ‰ç…§å­—é¢æ„æ€æˆ‘ä»¬éœ€è¦<strong>UniswapV2Pair</strong>çš„åˆçº¦, <strong>token0, token1</strong>ç»„æˆçš„salt,æœ€åé¢å†è°ƒç”¨UniswapV2Pairçš„åˆå§‹åŒ–å‡½æ•°,å³å®Œæˆäº†æ•´ä¸ªcreate2çš„ä½¿ç”¨,</li>
<li>å¯¹çš„,å°±æ˜¯è¿™ä¹ˆç®€å•.é‚£ä¹ˆè¿™æ ·å•ç‹¬æŠ½å‡ºä¸€ä¸ª<strong>UniswapV2Factory</strong>çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢?</li>
<li><p>å› ä¸ºæˆ‘ä»¬æ˜¯æ‰¹é‡åˆ›å»ºç›¸åŒçš„åˆçº¦,åªæ˜¯æ¯ä¸ªåˆçº¦çš„é‡Œé¢è®°å½•çš„æ•°æ®ä¸åŒè€Œå·²,æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿˜å¾—å¼•å…¥å¦ä¸€ä¸ªåˆçº¦å‡½æ•°æ¥é…åˆä½¿ç”¨,ä»–å°±æ˜¯<br><a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/libraries/UniswapV2Library.sol" target="_blank" rel="noopener">UniswapV2Library</a>ä¸­çš„pairForæ–¹æ³•,æ­¤æ–¹æ³•å¯ä»¥æ ¹æ®åˆ›å»ºçš„å‚æ•°è¿”å›æ­£ç¡®çš„åˆçº¦åœ°å€.å…¶ä¸­factoryå‚æ•°å°±æ˜¯ä¸Šè¿°ä½¿ç”¨create2çš„åˆçº¦åœ°å€</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculates the CREATE2 address for a pair without making any external calls</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pairFor</span>(<span class="params">address factory, address tokenA, address tokenB</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">address pair</span>) </span>&#123;</span><br><span class="line">    (address token0, address token1) = sortTokens(tokenA, tokenB);</span><br><span class="line">    pair = address(uint(keccak256(abi.encodePacked(</span><br><span class="line">            hex<span class="string">'ff'</span>,			<span class="comment">// å›ºå®šå€¼</span></span><br><span class="line">            factory,			<span class="comment">// ä½¿ç”¨create2çš„åˆçº¦åœ°å€</span></span><br><span class="line">            keccak256(abi.encodePacked(token0, token1)), <span class="comment">// ç¡®å®šå”¯ä¸€çš„åˆçº¦</span></span><br><span class="line">            hex<span class="string">'96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f'</span> <span class="comment">// init code hash</span></span><br><span class="line">        ))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="å­¦ä»¥è‡´ç”¨"><a href="#å­¦ä»¥è‡´ç”¨" class="headerlink" title="å­¦ä»¥è‡´ç”¨"></a>å­¦ä»¥è‡´ç”¨</h4><blockquote>
<p>æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨create2å®ç°ä¸€ä¸ªåŠŸèƒ½,è®°å½•Appleæ‰‹æœºçš„åˆ¶ä½œæµç¨‹,å…·ä½“ä½¿ç”¨AppleFactoryå®šä¹‰æ‰‹æœºçš„ä¿¡æ¯,ç„¶åæŠŠæŒ‡å®šå…·ä½“çš„å·¥å‚æ¥åŠ å·¥ç”Ÿäº§å‡ºApple,å¹¶å°†æ•°æ®ä¿å­˜åœ¨åŒºå—é“¾ä¸Š</p>
</blockquote>
<ol>
<li>ä¸€å°æ‰‹æœºåŒ…æ‹¬å”¯ä¸€åºåˆ—å·,å¤–è§‚é¢œè‰²,è¿è¡Œå†…å­˜å¤§å°,ä»¥åŠå­˜å‚¨ç©ºé—´,è¿™é‡ŒåŠ äº†ä¸€ä¸ªåŠ å·¥æ¬¡æ•°æ¥è®°å½•æ•´ä¸ªæµç¨‹,å…¶ä¸­æ ¸å¿ƒæ–¹æ³•<strong>initialize</strong>ä¸ºåˆå§‹åŒ–æ­¤äº§å“çš„åŸºæœ¬ä¿¡æ¯,<br><strong>processAction</strong>è®°å½•åŠ å·¥æµç¨‹, <strong>updatePlayer</strong>äº¤æ¥ç»™ä¸‹ä¸€ä¸ªå·¥å‚å®Œæˆç»§ç»­åˆ¶é€ </li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line">pragma experimental ABIEncoderV2;</span><br><span class="line"></span><br><span class="line">contract Apple &#123;</span><br><span class="line">    struct Action &#123;</span><br><span class="line">        uint step;</span><br><span class="line">        string <span class="keyword">from</span>;</span><br><span class="line">        string to;</span><br><span class="line">        uint256 time;</span><br><span class="line">        address player;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint256 public id;                      <span class="comment">// åºåˆ—å·</span></span><br><span class="line">    string public color;                    <span class="comment">//é¢œè‰²</span></span><br><span class="line">    uint256 public flashMemory;             <span class="comment">// è¿è¡Œå†…å­˜å¤§å° 4g</span></span><br><span class="line">    uint256 public diskMemory;              <span class="comment">//  å‚¨å­˜ç©ºé—´å¤§å° 256g</span></span><br><span class="line">    address public player;                  <span class="comment">// å¯ä»¥æ›´æ–°æ­¤åˆçº¦æ•°æ®çš„ç”¨æˆ·</span></span><br><span class="line">    uint256 public actionCount;             <span class="comment">// æ€»å…±åŠ å·¥æ¬¡æ•°</span></span><br><span class="line">    Action[] public actions;</span><br><span class="line">    address public factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getApple</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">view</span></span></span><br><span class="line"><span class="function">    <span class="title">returns</span> (<span class="params">uint _id, uint _memory, uint _disk, uint _count, address _player, string memory _color</span>)</span>&#123;</span><br><span class="line">        _id = id;</span><br><span class="line">        _memory = flashMemory;</span><br><span class="line">        _disk = diskMemory;</span><br><span class="line">        _count = actionCount;</span><br><span class="line">        _player = player;</span><br><span class="line">        _color = color;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        factory = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Trace(address player, string <span class="keyword">from</span>, string to, uint256 time);</span><br><span class="line">    event PlayerUpdate(address _pre, address newPlayer, uint256 time);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        address _player,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _id,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _memory,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _disk,</span></span></span><br><span class="line"><span class="function"><span class="params">        string memory _color</span>)</span></span><br><span class="line"><span class="function">    <span class="title">external</span> </span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.sender == factory, <span class="string">"permission deny"</span>);</span><br><span class="line">        player = _player;</span><br><span class="line">        id = _id;</span><br><span class="line">        color = _color;</span><br><span class="line">        flashMemory = _memory;</span><br><span class="line">        diskMemory = _disk;</span><br><span class="line">        _processAction(<span class="string">"apple"</span>, <span class="string">"init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getActions</span>(<span class="params">uint _start, uint _end</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">Action[] memory atcs</span>)</span>&#123;</span><br><span class="line">        uint end = _end + <span class="number">1</span> &gt;=  actions.length ? actions.length : _end;</span><br><span class="line">        atcs = <span class="keyword">new</span> Action[](end - _start);</span><br><span class="line">        <span class="keyword">for</span> (uint i = _start; i &lt; end; i++) &#123;</span><br><span class="line">            atcs[i - _start] = actions[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyPlayer &#123;</span><br><span class="line">        <span class="built_in">require</span>(player == msg.sender, <span class="string">"permission deny"</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">updatePlayer</span>(<span class="params">address _player</span>) <span class="title">onlyPlayer</span> <span class="title">external</span> </span>&#123;</span><br><span class="line">        address oldPlayer = player;</span><br><span class="line">        player = _player;</span><br><span class="line">        emit PlayerUpdate(oldPlayer, _player, block.timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_processAction</span>(<span class="params">string memory _from, string memory _to</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">        actionCount += <span class="number">1</span>;</span><br><span class="line">        actions.push(Action(&#123;<span class="attr">from</span> : _from, <span class="attr">to</span> : _to, <span class="attr">time</span> : block.timestamp, <span class="attr">step</span> : actionCount,<span class="attr">player</span>:msg.sender&#125;));</span><br><span class="line">        emit Trace(player, _from, _to, block.timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">processAction</span>(<span class="params">string memory _from, string memory _to</span>) <span class="title">onlyPlayer</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        _processAction(_from, _to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>factoryåˆçº¦åº”ç”±è‹¹æœå…¬å¸æ ¹æ®å®é™…çš„ç”Ÿäº§æƒ…å†µè¿›è¡Œç®¡ç†,å¹¶å½•å…¥åŸºæœ¬ä¿¡æ¯(æ­¤å¤„ç”±äºæµ‹è¯•,ä»»ä½•äººéƒ½å¯ä»¥åˆ›å»º),æ­¤å¤„çš„<strong>makeApple</strong>å³ä½¿ç”Ÿäº§apple, <strong>getApple</strong>å¯ä»¥ç”¨æ¥å¾—åˆ°ç”Ÿäº§å‡ºæ¥çš„appleçš„å…·ä½“åˆçº¦åœ°å€,</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./Apple.sol"</span>;</span><br><span class="line"></span><br><span class="line">interface IApple &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params">address _player, uint256 _id, uint256 _mem, uint256 _disk, string memory _c</span>) <span class="title">external</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">AppleFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    address[] public apples;</span><br><span class="line"></span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> bool) public checkApple;</span><br><span class="line">    </span><br><span class="line">    bytes32 public hash;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getAllApples</span>(<span class="params">uint _start, uint _end</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">address[] memory _apples</span>)</span>&#123;</span><br><span class="line">        _apples = <span class="keyword">new</span> address[](_end - _start);</span><br><span class="line">        <span class="keyword">for</span>(uint i = _start; i &lt; _end ; i++)&#123;</span><br><span class="line">            _apples[i - _start] = apples[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">totalApple</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> apples.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event AppleCreated(address maker, uint256 _id, uint256 _memory, uint256 _disk, string _color, address _apple);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">makeApple</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _memory,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint256 _disk,</span></span></span><br><span class="line"><span class="function"><span class="params">        string memory _color</span>)</span></span><br><span class="line"><span class="function">    <span class="title">external</span> <span class="title">returns</span> (<span class="params">address apple</span>) </span>&#123;</span><br><span class="line">        uint256 _id = apples.length + <span class="number">1</span>;</span><br><span class="line">        bytes memory bytecode = type(Apple).creationCode;</span><br><span class="line">        <span class="keyword">if</span> (hash == bytes32(<span class="number">0</span>)) &#123;</span><br><span class="line">            hash = keccak256(bytecode);</span><br><span class="line">        &#125;</span><br><span class="line">        bytes32 salt = keccak256(abi.encodePacked(_id, _memory, _color));</span><br><span class="line">        assembly &#123;</span><br><span class="line">            apple := create2(<span class="number">0</span>, add(bytecode, <span class="number">32</span>), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">require</span>(checkApple[apple] == <span class="literal">false</span>, <span class="string">'this apple have been made'</span>);</span><br><span class="line">        IApple(apple).initialize(msg.sender, _id, _memory, _disk, _color);</span><br><span class="line">        apples.push(apple);</span><br><span class="line">        emit AppleCreated(msg.sender, _id, _memory, _disk, _color, apple);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// å¯ä»¥é€šè¿‡åŒæ ·çš„å‚æ•°è®¡ç®—å‡ºå¯¹åº”çš„åˆçº¦åœ°å€</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getApple</span>(<span class="params">int256 _id, uint256 _memory, uint256 _disk, string calldata _color</span>)</span></span><br><span class="line"><span class="function">    <span class="title">external</span></span></span><br><span class="line"><span class="function">    <span class="title">view</span></span></span><br><span class="line"><span class="function">    <span class="title">returns</span> (<span class="params">address apple</span>)</span>&#123;</span><br><span class="line">        apple = address(uint(keccak256(abi.encodePacked(</span><br><span class="line">                hex<span class="string">'ff'</span>,</span><br><span class="line">                address(<span class="keyword">this</span>),</span><br><span class="line">                keccak256(abi.encodePacked(_id, _memory, _disk, _color)),</span><br><span class="line">                hash</span><br><span class="line">            ))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/xswap/ether4.gif" alt="demo"></p>
<h4 id="demoæ¼”ç¤º"><a href="#demoæ¼”ç¤º" class="headerlink" title="demoæ¼”ç¤º"></a>demoæ¼”ç¤º</h4><ul>
<li><a href="https://github.com/shaokun11/xswap/tree/v2" target="_blank" rel="noopener">å‰ç«¯æºç </a>,<a href="https://github.com/shaokun11/solidity-env-hardhat/tree/v3" target="_blank" rel="noopener">åˆçº¦æºç </a></li>
<li>é¦–å…ˆåˆ¶é€ æˆäº§äº†ä¸€å°iPhone,å¡«å…¥é¢œè‰²,å†…å­˜ä¸å‚¨å­˜ç©ºé—´</li>
<li>è¿›å…¥åŠ å·¥ç¯èŠ‚,å½“æ‰§è¡Œprocessæ—¶,è‡ªåŠ¨è¿›å…¥åˆ°ä¸‹ä¸€ä¸ªåŠ å·¥ç¯èŠ‚</li>
<li>â€¦</li>
<li>è·Ÿéšè€…åŠ å·¥æµç¨‹æŒ‡å¯¼åŠ å·¥ç”Ÿäº§å®Œæˆ,è¿™æ ·å¯ä»¥è®°å½•æ¯ä¸€å°æ‰‹æœºçš„ç”Ÿäº§æµç¨‹,ä¸”å…·ä½“çš„æµç¨‹å¯ä¿¡</li>
</ul>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol>
<li>å¯ä»¥æŒ‰ç…§ç¼–ç¨‹è¯­è¨€ä¸­çš„é¢å‘å¯¹è±¡æ€æƒ³è¿›è¡Œç†è§£,create2ä¼ å…¥çš„å‚æ•°bytecodeå°±æ˜¯classçš„å­—èŠ‚ç ,è€Œcreate2ç›¸å½“äºnew,è€Œæˆ‘ä»¬åˆå¯ä»¥æ ¹æ®ä¼ å…¥create2åŠ ä¸Šå…¶factoryçš„åœ°å€ä»¥åŠsaltæ¢å¤æ‰¾åˆ°ä»¥è¿™saltä¸ºkeyçš„åˆçº¦åœ°å€ä¸”å”¯ä¸€,è€Œä¸”åˆçº¦çš„åœ°å€æå‰å¯çŸ¥å‘¢.Ã“Â´</li>
<li>é‚£ä¹ˆæŒ‰ç…§ä»‹ç»ä½¿ç”¨create2,æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªåˆçº¦,ä¸€ä¸ªtemplateåˆçº¦(ç±»),ä¸€ä¸ªfactoryåˆçº¦(è´Ÿè´£new)å³å¯,æ˜¯ä¸æ˜¯å¾ˆç®€å•çš„?</li>
<li>å¦‚æœä½¿ç”¨create2åˆ›å»ºäº†ä¸€ä¸ªåˆçº¦,å†ä½¿ç”¨åŒæ ·çš„å‚æ•°è¿›è¡Œè°ƒç”¨,æ˜¯ä¸èƒ½æˆåŠŸçš„,é™¤éå·²åˆ›å»ºçš„åˆçº¦è°ƒç”¨selfdestruct(address)é‡Šæ”¾æ‰æ‰è¡Œ</li>
<li>æ¥ä¸‹æ¥å°±å¯ä»¥è¿›å…¥åˆ°åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æ‰€æåˆ°çš„ä¸‰ä¸ªåˆçº¦ä¸­çš„<strong>UniswapV2Pair</strong>,ä¹Ÿå³ä½¿æœ€åä¸€ä¸ªåˆçº¦</li>
<li>å…¶å®åˆ°è¿™é‡Œæ¥è¯´,åˆçº¦çŸ¥è¯†ä¸­çš„éš¾ç‚¹å·²ç»è®²è§£çš„å·®ä¸å¤šäº†,å‰©ä¸‹çš„å…¶å®æ˜¯å…³äºuniswapä¸­çš„åˆ›æ–°æ€æƒ³çš„å¤ä¹ å’¯</li>
</ol>
<h4 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h4><p>åŒºå—é“¾ç¨‹åºçŒ¿ä¸€æš<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/27/uniswap æºç è§£è¯»3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/27/uniswap æºç è§£è¯»3/" itemprop="url">ä¸€æ­¥ä¸€æ­¥æ•™ä½ æ‰“é€ è‡ªå·±çš„defi-xswap(3)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-10-27T20:15:25+08:00">
                2020-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦çœ‹çœ‹UniswapV2Pairçš„çˆ¶ç±»åˆçº¦UniswapV2ERC20,ä¸»è¦å­¦ä¹ ä¸€ä¸‹eip712</p>
</blockquote>
<h4 id="UniswapV2ERC20"><a href="#UniswapV2ERC20" class="headerlink" title="UniswapV2ERC20"></a>UniswapV2ERC20</h4><blockquote>
<p>æ­¤åˆçº¦å¦‚æœç†Ÿæ‚‰ERC20 tokençš„åŒå­¦ä¸€å®šçŸ¥é“,å¥¹å…¶å®æ˜¯æ ‡å‡†çš„erc20åˆçº¦(å…¶æ ‡å‡†çš„erc20åˆçº¦çš„å†…å®¹æ­¤å¤„å°±ä¸å†è¯¦ç»†ä»‹ç»äº†)<br>ä½†æ˜¯ç›¸å¯¹æ ‡å‡†çš„erc20åˆçº¦å¤šäº†ä¸€ä¸ªpermitæ–¹æ³•,é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä»€ä¹ˆä»€ä¹ˆå‘¢?å…¶å®æ˜¯eip721çš„ä¸€ä¸ªå®ç°</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">contract UniswapV2ERC20 is IUniswapV2ERC20 &#123;</span><br><span class="line">    using SafeMath <span class="keyword">for</span> uint;</span><br><span class="line"></span><br><span class="line">    string public constant name = <span class="string">'Uniswap V2'</span>;</span><br><span class="line">    string public constant symbol = <span class="string">'UNI-V2'</span>;</span><br><span class="line">    uint8 public constant decimals = 18;</span><br><span class="line">    uint  public totalSupply;</span><br><span class="line">    mapping(address =&gt; uint) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint)) public allowance;</span><br><span class="line"></span><br><span class="line">    bytes32 public DOMAIN_SEPARATOR;</span><br><span class="line">    // keccak256(<span class="string">"Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"</span>);</span><br><span class="line">    bytes32 public constant PERMIT_TYPEHASH = 0x6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c9;</span><br><span class="line">    mapping(address =&gt; uint) public nonces;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        uint chainId;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            chainId := chainid</span><br><span class="line">        &#125;</span><br><span class="line">        DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">            abi.encode(</span><br><span class="line">                keccak256(<span class="string">'EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)'</span>),</span><br><span class="line">                keccak256(bytes(name)),</span><br><span class="line">                keccak256(bytes(<span class="string">'1'</span>)),</span><br><span class="line">                chainId,</span><br><span class="line">                address(this)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _mint(address to, uint value) internal &#123;</span><br><span class="line">        totalSupply = totalSupply.add(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(address(0), to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _burn(address from, uint value) internal &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        totalSupply = totalSupply.sub(value);</span><br><span class="line">        emit Transfer(from, address(0), value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _approve(address owner, address spender, uint value) private &#123;</span><br><span class="line">        allowance[owner][spender] = value;</span><br><span class="line">        emit Approval(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> _transfer(address from, address to, uint value) private &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> approve(address spender, uint value) external returns (bool) &#123;</span><br><span class="line">        _approve(msg.sender, spender, value);</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> transfer(address to, uint value) external returns (bool) &#123;</span><br><span class="line">        _transfer(msg.sender, to, value);</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> transferFrom(address from, address to, uint value) external returns (bool) &#123;</span><br><span class="line">        <span class="keyword">if</span> (allowance[from][msg.sender] != uint(-1)) &#123;</span><br><span class="line">            allowance[from][msg.sender] = allowance[from][msg.sender].sub(value);</span><br><span class="line">        &#125;</span><br><span class="line">        _transfer(from, to, value);</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external &#123;</span><br><span class="line">        require(deadline &gt;= block.timestamp, <span class="string">'UniswapV2: EXPIRED'</span>);</span><br><span class="line">        bytes32 digest = keccak256(</span><br><span class="line">            abi.encodePacked(</span><br><span class="line">                <span class="string">'\x19\x01'</span>,</span><br><span class="line">                DOMAIN_SEPARATOR,</span><br><span class="line">                keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, nonces[owner]++, deadline))</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        address recoveredAddress = ecrecover(digest, v, r, s);</span><br><span class="line">        require(recoveredAddress != address(0) &amp;&amp; recoveredAddress == owner, <span class="string">'UniswapV2: INVALID_SIGNATURE'</span>);</span><br><span class="line">        _approve(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="UniswapV2ERC20ä¸­çš„eip712"><a href="#UniswapV2ERC20ä¸­çš„eip712" class="headerlink" title="UniswapV2ERC20ä¸­çš„eip712"></a>UniswapV2ERC20ä¸­çš„eip712</h4><ol>
<li><a href="https://github.com/0xProject/EIPs/blob/master/EIPS/eip-712.md" target="_blank" rel="noopener">eip712</a>å…¶å®æ˜¯ä¹Ÿæ˜¯ç”¨ä½ çš„ç§é’¥å¯¹ä¸€æ®µæ–‡å­—è¿›è¡Œç­¾å,ä½†æ˜¯ç­¾åçš„è¿‡ç¨‹ä¸­æ›´åŠ è¯­ä¹‰åŒ–,ç›®å‰metamaskå·²ç»æ”¯æŒ,æ¥ä¸‹æ¥çœ‹çœ‹premitä¸­çš„æ ¸å¿ƒæ–¹æ³•</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bytes32 digest = keccak256(</span><br><span class="line">         abi.encodePacked(</span><br><span class="line">             &apos;\x19\x01&apos;,</span><br><span class="line">             DOMAIN_SEPARATOR,</span><br><span class="line">             keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, nonces[owner]++, deadline))</span><br><span class="line">         )</span><br><span class="line">     );</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>ç¬¬ä¸€ä¸ªå‚æ•° <strong>\x19\x01</strong> å›ºå®šå€¼,ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ª?è¯·å‚è€ƒä¸Šé¢çš„é“¾æ¥</li>
<li>ç¬¬äºŒä¸ªå‚æ•°:<strong>DOMAIN_SEPARATOR</strong> å…¶ç­¾åä¸€èˆ¬å¦‚ä¸‹,å›ºå®šå€¼,åœ¨åˆçº¦çš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–,æ ‡å¿—ç€åªæ˜¯eip712çš„å®ç°</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)</span><br><span class="line"> constructor() public &#123;</span><br><span class="line">       uint chainId;</span><br><span class="line">       assembly &#123;</span><br><span class="line">           chainId := chainid</span><br><span class="line">       &#125;</span><br><span class="line">       DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">           abi.encode(</span><br><span class="line">               keccak256(<span class="string">'EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)'</span>),</span><br><span class="line">               keccak256(bytes(name)),	</span><br><span class="line">               keccak256(bytes(<span class="string">'1'</span>)),</span><br><span class="line">               chainId,</span><br><span class="line">               address(this)</span><br><span class="line">           )</span><br><span class="line">       );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>ç¬¬ä¸‰ä¸ªå‚æ•°çš„å‰æ®µéƒ¨åˆ† <strong>PERMIT_TYPEHASH</strong>,ä¸DOMAIN_SEPARATORçš„å«ä¹‰ç±»ä¼¼,ä»£è¡¨ç€è¿™ä¸ªå‡½æ•°çš„ç­¾å</li>
<li>ç¬¬ä¸‰ä¸ªå‚æ•°çš„åç«¯éƒ¨åˆ†ç»Ÿä¸€ç†è§£ä¸ºä¼ è¿›æ¥signatureå¯¹åº”çš„æ•°æ®,æ­¤å¤„ç”¨v,r,sä»£æ›¿  </li>
</ol>
<h4 id="eip712çš„ç®€å•å®ç°"><a href="#eip712çš„ç®€å•å®ç°" class="headerlink" title="eip712çš„ç®€å•å®ç°"></a>eip712çš„ç®€å•å®ç°</h4><ul>
<li><p>æ­¤å¤„é‡‡ç”¨çš„ç»“æ„ä¸º <strong>keccak256(â€˜Test(address owner,uint256 amount,uint256 nonce)â€™)</strong>,æ­¤å¤„æ³¨æ„æ•°æ®ç±»å‹å’Œå­—æ®µåä¸­é—´æœ‰ä¸€ä¸ªç©ºæ ¼,å‚æ•°ä¹‹é—´çš„é€—å·ä¹‹é—´æ²¡æœ‰ç©ºæ ¼     </p>
</li>
<li><p>eip712ä¸»è¦åŠŸèƒ½æ˜¯èƒ½å¤Ÿç¦»çº¿ç­¾å,è®©ä»»æ„çš„äººå¯ä»¥ä»£æ›¿ä½ åšåŒæ ·çš„äº‹æƒ…,ç›¸å½“äºæˆæƒ.æ­¤å¤„ä»…åšæ¼”ç¤ºç­¾ååçš„åœ°å€æ­£ç¡®æ€§  </p>
</li>
<li><p>æ­¤å¤„ä»…æµ‹è¯•éªŒè¯ç»“æœæˆåŠŸå³å¢åŠ ç”¨æˆ·è¾“å…¥çš„amount </p>
</li>
<li><p><a href="https://github.com/shaokun11/solidity-env-hardhat/blob/master/contracts/TestEip712.sol" target="_blank" rel="noopener">åˆçº¦æºç </a></p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.7</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    bytes32 public DOMAIN_SEPARATOR;</span><br><span class="line">    address public rc;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public nonces;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public amounts;</span><br><span class="line">    bytes32 public constant TEST_TYPEHASH = keccak256(<span class="string">'Test(address owner,uint256 amount,uint256 nonce)'</span>);</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        uint chainId;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            chainId := chainid() <span class="comment">// å¤§äº6.0ä»¥ä¸Šæ˜¯ä¸ªæ–¹æ³•,ä¸æ˜¯å±æ€§</span></span><br><span class="line">        &#125;</span><br><span class="line">        DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">            abi.encode(</span><br><span class="line">                keccak256(<span class="string">'EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)'</span>),</span><br><span class="line">                keccak256(bytes(<span class="string">"shaokun"</span>)), <span class="comment">// æ­¤å¤„ä¸€èˆ¬å¡«å†™æ­¤åˆçº¦æœ‰æ„ä¹‰çš„å€¼</span></span><br><span class="line">                keccak256(bytes(<span class="string">'1'</span>)),</span><br><span class="line">                chainId,</span><br><span class="line">                address(<span class="keyword">this</span>)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testEIP712</span>(<span class="params">address owner, uint256 amount, uint8 v, bytes32 r, bytes32 s</span>) <span class="title">external</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        bytes32 digest = keccak256(</span><br><span class="line">            abi.encodePacked(<span class="string">'\x19\x01'</span>,</span><br><span class="line">            DOMAIN_SEPARATOR,</span><br><span class="line">            keccak256(abi.encode(TEST_TYPEHASH, owner, amount, nonces[owner]++))</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        address recoveredAddress = ecrecover(digest, v, r, s);</span><br><span class="line">        <span class="built_in">require</span>(recoveredAddress != address(<span class="number">0</span>) &amp;&amp; recoveredAddress == owner, <span class="string">"account not fit"</span>);</span><br><span class="line">        rc = recoveredAddress;</span><br><span class="line">        amounts[owner] += amount;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æµç¨‹æ¼”ç¤º"><a href="#æµç¨‹æ¼”ç¤º" class="headerlink" title="æµç¨‹æ¼”ç¤º"></a>æµç¨‹æ¼”ç¤º</h4><blockquote>
<p>è¿™ä¸€å‘¨èŠ±äº†ç‚¹æ—¶é—´ç”¨reactåšäº†ä¸ªUI,ä½¿ç”¨äº†react + react-materialå¼€å‘UI,web3-reactå®ç°ä¸åŒºå—é“¾çš„äº¤äº’<a href="https://github.com/shaokun11/xswap" target="_blank" rel="noopener">xswapå‰ç«¯</a></p>
</blockquote>
<ol>
<li>ä½¿ç”¨remixéƒ¨ç½²åˆçº¦åœ¨rinkebyæµ‹è¯•é“¾ä¸Š,åˆçº¦åœ°å€<strong>0x9F8C390b7048395d4DeBc7636031aD992115C303</strong> <a href="https://rinkeby.etherscan.io/address/0x9F8C390b7048395d4DeBc7636031aD992115C303" target="_blank" rel="noopener">ethersacn</a></li>
<li>ä»é“¾ä¸Šè¯»å‡ºå½“å‰ç­¾åæ‰€ç”¨çš„nonce</li>
<li>æ ¹æ®nonceä¸amountä½¿ç”¨è´¦å·è¿›è¡Œç­¾å,å¹¶å‘é€åˆ°é“¾ä¸Š</li>
<li>å½“äº¤æ˜“æ‰§è¡ŒæˆåŠŸ,è·å–æ–°çš„nonceå’Œamount,éªŒè¯ç»“æœ</li>
<li>å†æ¬¡æ‰§è¡Œç­¾å,å°†è·å–çš„ç­¾åæ•°æ®(å…¶ä¸­å¦‚æœæ•°é‡ä¸º25,å‘é€å°†ä¼šæé†’å¤±è´¥,æ”¹ä¸ºç­¾åçš„æ•°æ®19åˆ™æ­£å¸¸å¼¹å‡ºmetamask)é€šè¿‡remixå‘é€,ç­‰å¾…äº¤æ˜“ç»“æœåè¿”å›é¡µé¢æŸ¥è¯¢æ•°æ®å·²ç»æ›´æ”¹  </li>
</ol>
<p><img src="/xswap/ether3.gif" alt="demo"></p>
<h4 id="jsç­¾åæµç¨‹"><a href="#jsç­¾åæµç¨‹" class="headerlink" title="jsç­¾åæµç¨‹"></a>jsç­¾åæµç¨‹</h4><blockquote>
<p>ç›®å‰web3ä¸æ”¯æŒæ­¤ç±»ç­¾åæ–¹å¼,metamaskæ˜¯æ”¯æŒçš„,è¯·æ³¨æ„ä¸€ä¸‹ç­¾åçš„è¯·æ±‚æ–¹å¼</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸¤ä¸ªå­—æ®µ typesä¸domain</span></span><br><span class="line"><span class="keyword">const</span> eip712Obj = &#123;</span><br><span class="line">    types: &#123;</span><br><span class="line">        EIP712Domain: [</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'name'</span>, <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'version'</span>, <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'chainId'</span>, <span class="attr">type</span>: <span class="string">'uint256'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'verifyingContract'</span>, <span class="attr">type</span>: <span class="string">'address'</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="comment">// ç­¾åçš„ç»“æ„,ä¸åˆçº¦ä¿æŒä¸€è‡´</span></span><br><span class="line">        Test: [</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'owner'</span>, <span class="attr">type</span>: <span class="string">'address'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'amount'</span>, <span class="attr">type</span>: <span class="string">'uint256'</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">'nonce'</span>, <span class="attr">type</span>: <span class="string">'uint256'</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">   	</span><br><span class="line">    domain: <span class="function">(<span class="params">chainId: number</span>) =&gt;</span> (&#123;</span><br><span class="line">        name: <span class="string">'shaokun'</span>,</span><br><span class="line">        version: <span class="string">'1'</span>,</span><br><span class="line">        chainId: chainId,</span><br><span class="line">        verifyingContract: <span class="string">'0x9F8C390b7048395d4DeBc7636031aD992115C303'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">// ç­¾åæ‰€è¦çš„æ•°æ®</span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            types: eip712Obj.types,		</span><br><span class="line">            domain: eip712Obj.domain(web3.chainId!!), <span class="comment">// è·å–å½“å‰çš„id,å¹¶è¿”å›ä¸åˆçº¦ä¸€è‡´çš„æ•°æ®</span></span><br><span class="line">            primaryType: <span class="string">'Test'</span>,	<span class="comment">// æœ€å¼€å§‹hashçš„ç±»å‹,å¦‚æœæœ‰å¤šä¸ªç±»å‹,éœ€æŒ‡å®šæŒ‰ç…§åˆçº¦çš„é¡ºåºçš„ç¬¬ä¸€ä¸ª</span></span><br><span class="line">            <span class="comment">// testçš„æ•°æ®å…·ä½“å†…å®¹</span></span><br><span class="line">            message: &#123;</span><br><span class="line">                owner: web3.account,</span><br><span class="line">                amount: inputV,</span><br><span class="line">                nonce,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å¤„ä½¿ç”¨çš„web3-react,provider ä¸ºmetamask</span></span><br><span class="line"> web3.library.provider.request(</span><br><span class="line">            &#123;</span><br><span class="line">                method: <span class="string">'eth_signTypedData_v4'</span>,</span><br><span class="line">                params: [web3.account, data],   <span class="comment">// ä¸¤ä¸ªå‚æ•°,ç¬¬ä¸€ä¸ªå¿…é¡»ä¸ºè´¦å·åœ°å€,ç¬¬äºŒä¸ª</span></span><br><span class="line">            &#125;).then(<span class="function">(<span class="params">result: string</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> signature = result.substring(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">const</span> r = <span class="string">'0x'</span> + signature.substring(<span class="number">0</span>, <span class="number">64</span>)</span><br><span class="line">            <span class="keyword">const</span> s = <span class="string">'0x'</span> + signature.substring(<span class="number">64</span>, <span class="number">128</span>)</span><br><span class="line">            <span class="keyword">const</span> v = <span class="built_in">parseInt</span>(signature.substring(<span class="number">128</span>, <span class="number">130</span>), <span class="number">16</span>)</span><br><span class="line">            <span class="comment">// å¾—åˆ°ç­¾åç»“æœçš„r,s,v,å‘é€åˆ°é“¾ä¸Šæ ¡éªŒå³å¯</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'---sign result -'</span>,&#123;r,s,v&#125;)</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul>
<li>å…³äºè¯­ä¹‰åŒ–ç­¾åçš„å°±ä»‹ç»åˆ°æ­¤äº†,é‚£ä¹ˆuniswapä¸­çš„permitçš„ä½œç”¨å°±æ˜¯ä¹Ÿå°±æ˜¯å¦‚æ­¤,è‡³äºæ€ä¹ˆä½¿ç”¨å®ƒæ˜¯æ€ä¹ˆä½¿ç”¨çš„å‘¢,åç»­å†çœ‹å§</li>
<li>UniswapV2ERC20 åŸºç¡€åˆçº¦å°±æ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹äº†,å…¶ä½™çš„æ–¹æ³•ä¸ºæ ‡å‡†çš„erc20 tokençš„æ–¹æ³•</li>
<li>æ¥ä¸‹æ¥è®²è§£<em>UniswapV2Factory</em>,åˆæ˜¯ä¸€ä¸ªå¼€å‘æ™ºèƒ½åˆçº¦å¾ˆé‡è¦çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹å‘¢</li>
</ul>
<h4 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h4><p>åŒºå—é“¾ç¨‹åºçŒ¿ä¸€æš<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/25/uniswap æºç è§£è¯»2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/25/uniswap æºç è§£è¯»2/" itemprop="url">ä¸€æ­¥ä¸€æ­¥æ•™ä½ æ‰“é€ è‡ªå·±çš„defi-xswap(2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-10-25T11:22:06+08:00">
                2020-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦çœ‹çœ‹uniswapçš„åˆçº¦çš„æºç å’Œç»“æ„,ä»¥åŠå¦‚ä½•æ‰¾åˆ°æºç çš„å…¥å£(å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥é˜…è¯»uniswapçš„docæ¥è¾¾åˆ°ç›®çš„)</p>
</blockquote>
<h4 id="è·å–æºç "><a href="#è·å–æºç " class="headerlink" title="è·å–æºç "></a>è·å–æºç </h4><p>ä»<a href="https://github.com/Uniswap/uniswap-v2-core" target="_blank" rel="noopener">uniswapåˆçº¦æºç  github</a>æŠŠæºç colneåˆ°æœ¬åœ°,è¿›å…¥contractç›®å½•  </p>
<ul>
<li>å¯ä»¥çœ‹åˆ°åˆçº¦çš„ä»£ç é‡ä¸å¤š,é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•å¼€å§‹å‘¢?</li>
<li>ä»ç›®å½•çš„å‘½åæ¥çœ‹,æˆ‘ä»¬è²Œä¼¼åªéœ€è¦å…³æ³¨æš´éœ²åœ¨å¤–é¢çš„ä¸‰ä¸ªåˆçº¦ UniswapV2ERC20.sol, UniswapV2Factory.sol, UniswapV2Pair.solå³å¯,å…¶ä»–çš„æ–‡ä»¶å¤¹çš„å†…å®¹ä¸ºinterfaceå’Œlibraries</li>
</ul>
<blockquote>
<p>è¿™é‡Œå¦‚æœä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥è¯•ç€runä¸€ä¸‹è¿™ä¸ªè¿™ä¸ªtest,ç„¶åæ ¹æ®testå»æŸ¥çœ‹é¡¹ç›®å¦‚ä½•æ‰§è¡Œçš„</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--  1 kun  staff  3435 10 25 11:14 UniswapV2ERC20.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  1867 10 25 11:14 UniswapV2Factory.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  9788 10 25 11:14 UniswapV2Pair.sol</span><br><span class="line">drwxr-xr-x  7 kun  staff   238 10 25 11:14 interfaces</span><br><span class="line">drwxr-xr-x  5 kun  staff   170 10 25 11:14 libraries</span><br><span class="line">drwxr-xr-x  3 kun  staff   102 10 25 11:14 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">./interfaces:</span><br><span class="line">total 40</span><br><span class="line">-rw-r--r--  1 kun  staff   823 10 25 11:14 IERC20.sol</span><br><span class="line">-rw-r--r--  1 kun  staff   159 10 25 11:14 IUniswapV2Callee.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  1148 10 25 11:14 IUniswapV2ERC20.sol</span><br><span class="line">-rw-r--r--  1 kun  staff   661 10 25 11:14 IUniswapV2Factory.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  2424 10 25 11:14 IUniswapV2Pair.sol</span><br><span class="line"></span><br><span class="line">./libraries:</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r--  1 kun  staff  602 10 25 11:14 Math.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  563 10 25 11:14 SafeMath.sol</span><br><span class="line">-rw-r--r--  1 kun  staff  578 10 25 11:14 UQ112x112.sol</span><br><span class="line"></span><br><span class="line">./<span class="built_in">test</span>:</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--  1 kun  staff  187 10 25 11:14 ERC20.sol</span><br></pre></td></tr></table></figure>
<h4 id="è¯•ç©uniswap"><a href="#è¯•ç©uniswap" class="headerlink" title="è¯•ç©uniswap"></a>è¯•ç©uniswap</h4><ol>
<li><a href="https://rinkeby.etherscan.io/tx/0x4f1551395b26afa5b270c42bf165e9a013db010b3e585bf9419a63e83866081d" target="_blank" rel="noopener">ethå…‘æ¢uni</a>,ä»etherscanä¸­å¯ä»¥çœ‹åˆ°å‡½æ•°ç­¾åä¸º<strong>swapExactETHForTokens</strong>   </li>
<li><a href="https://rinkeby.etherscan.io/tx/0x4f1551395b26afa5b270c42bf165e9a013db010b3e585bf9419a63e83866081d" target="_blank" rel="noopener">æ·»åŠ uni-&gt;ethçš„èµ„é‡‘æ± </a>,è°ƒç”¨çš„å‡½æ•°ç­¾åä¸º<strong>addLiquidityETH</strong>,(ä¸­é—´approveäº†ä¸¤æ¬¡æ­¤åˆçº¦å¯ä»¥è½¬ç§»æˆ‘é’±åŒ…ä¸­çš„uniçš„æ“ä½œ,ç¬¬äºŒæ¬¡æ˜¯é‡å¤çš„)  </li>
<li>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä»è¿™ä¸¤ä¸ªå‡½æ•°å¼€å§‹é˜…è¯»å…¶åˆçº¦ä»£ç    </li>
</ol>
<p><img src="/xswap/ether2.gif" alt="demo"></p>
<h4 id="routeråˆçº¦"><a href="#routeråˆçº¦" class="headerlink" title="routeråˆçº¦"></a>routeråˆçº¦</h4><ol>
<li>åœ¨æˆ‘ä»¬è¯•ç©æ‰¾å…¥å£æ—¶,æˆ‘ä»¬å‘ç°å…¶è°ƒç”¨çš„å‡½æ•°ç­¾åå¹¶æ²¡æœ‰åœ¨æˆ‘ä»¬Colneçš„é¡¹ç›®ä¸­æœ‰æ‰¾åˆ°,é‚£æ˜¯æ€ä¹ˆå›äº‹å‘¢?æŒ‰ç…§æ–‡æ¡£,è¿™æ˜¯uniswapä¸ºæˆ‘ä»¬çš„sdk,æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™åŸºç¡€çš„åˆçº¦åˆ›å»ºå±äºæˆ‘ä»¬çš„swap(æ˜¯çš„,æˆ‘ä»¬æ­£åœ¨åšè¿™ä»¶äº‹),è€Œä»–ä»¬è‡ªå·±ä¹Ÿåšäº†ä¸€ä¸ªswap <a href="https://github.com/Uniswap/uniswap-v2-periphery" target="_blank" rel="noopener">uniswapåˆçº¦æºç </a>,è¿™ä¸ªæ‰æ˜¯ä»–ä»¬åŸºäºsdkå¼€å‘çš„ä¸€ä¸ªåº”ç”¨å‘¢</li>
<li>é‚£æˆ‘ä»¬æ ¹æ®<a href="https://rinkeby.etherscan.io/tx/0x4f1551395b26afa5b270c42bf165e9a013db010b3e585bf9419a63e83866081d" target="_blank" rel="noopener">ethå…‘æ¢uni</a>è¿™ç¬”äº¤æ˜“,æ‰¾åˆ°å…¶åœ¨etherscanä¸ŠéªŒè¯è¿‡çš„çš„åˆçº¦,å‘ç°å…¶å®é™…è°ƒç”¨çš„æ˜¯<em>UniswapV2Router02</em>è¿™ä¸ªå‡½æ•°åçš„åˆçº¦,å…¨å±€æœç´¢æ‰¾åˆ°å…¶å‡½æ•°ç­¾åå¦‚ä¸‹  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline)</span><br><span class="line">     external</span><br><span class="line">     virtual</span><br><span class="line">     override</span><br><span class="line">     payable</span><br><span class="line">     ensure(deadline)</span><br><span class="line">     returns (uint[] memory amounts)</span><br><span class="line"> &#123;</span><br><span class="line">     require(path[0] == WETH, &apos;UniswapV2Router: INVALID_PATH&apos;);</span><br><span class="line">     amounts = UniswapV2Library.getAmountsOut(factory, msg.value, path);</span><br><span class="line">     require(amounts[amounts.length - 1] &gt;= amountOutMin, &apos;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&apos;);</span><br><span class="line">     IWETH(WETH).deposit&#123;value: amounts[0]&#125;();</span><br><span class="line">     assert(IWETH(WETH).transfer(UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]));</span><br><span class="line">     _swap(amounts, path, to);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>å…ˆå¿½ç•¥<strong>UniswapV2Library</strong>æ–¹æ³•,è§‚å¯Ÿæ­¤åˆçº¦,å…¶æ ¸å¿ƒæ–¹æ³•é›†ä¸­åœ¨<strong>_swap(amounts, path, to)</strong>è¿™ä¸ªæ–¹æ³•ä¸Š,ç»§ç»­æœç´¢å¯ä»¥å‘ç°å¾ˆå¤šæ–¹æ³•éƒ½è°ƒç”¨äº†æ­¤æ–¹æ³•</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// **** SWAP ****</span><br><span class="line">// requires the initial amount to have already been sent to the first pair</span><br><span class="line">function _swap(uint[] memory amounts, address[] memory path, address _to) internal virtual &#123;</span><br><span class="line">    for (uint i; i &lt; path.length - 1; i++) &#123;</span><br><span class="line">        (address input, address output) = (path[i], path[i + 1]);</span><br><span class="line">        (address token0,) = UniswapV2Library.sortTokens(input, output);</span><br><span class="line">        uint amountOut = amounts[i + 1];</span><br><span class="line">        (uint amount0Out, uint amount1Out) = input == token0 ? (uint(0), amountOut) : (amountOut, uint(0));</span><br><span class="line">        address to = i &lt; path.length - 2 ? UniswapV2Library.pairFor(factory, output, path[i + 2]) : _to;</span><br><span class="line">        IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(</span><br><span class="line">            amount0Out, amount1Out, to, new bytes(0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>å‘ç°å…¶æœ€ç»ˆè½åœ¨äº†**IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(<pre><code>    amount0Out, amount1Out, to, new bytes(0)
);**è¿™ä¸ªæ–¹æ³•ä¸Š,è¿™ä¸ªæ–¹æ³•å°±åœ¨æˆ‘ä»¬çš„cloneé¡¹ç›®ä¸­äº†,é‚£ä¹ˆå…¶æ ¸å¿ƒæ–¹æ³•æˆ‘ä»¬å°±åªè¦å…³å¿ƒ**IUniswapV2Pair. swap()**  
5. ä¸ºä»€ä¹ˆæˆ‘ä»¬colneé¡¹ç›®ä¸­æ²¡æœ‰è¿™ä¸ªrouterçš„åˆçº¦? (æœ¬ç³»åˆ—ç»“æŸåå›ç­”)  
</code></pre></li>
</ol>
<blockquote>
<p>åªæœ‰åœ¨etherscanä¸ŠéªŒè¯è¿‡çš„åˆçº¦æ‰èƒ½å¤Ÿæ‰¾åˆ°å…¶åˆçº¦å…ƒam,è¿™ä¹Ÿæ˜¯æœ€çœŸå®çš„,å¦‚æœåšdefi,ä¸€èˆ¬ä¼šå°†å…¶éªŒè¯,å¢åŠ å…¶å»ä¸­å¿ƒåŒ–çš„å…¬ä¿¡åŠ›</p>
</blockquote>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol>
<li><p>é€šè¿‡ä¸€ç³»åˆ—çš„æ“ä½œ,æˆ‘ä»¬æ€»ç®—æ‰¾åˆ°äº†åˆçº¦å…¥å£å•¦,æ¥ä¸‹æ¥åº”è¯¥è¿›å…¥åˆ°æ­£å¼çš„åˆçº¦é˜…è¯»æ­¥éª¤å•¦,æ˜¯ä¸æ˜¯å¾ˆæ¿€åŠ¨?</p>
</li>
<li><p>å…¶ä¸­æœ‰äº›ç»†èŠ‚æˆ‘è§‰å¾—é€šè¿‡æ–‡å­—æ¥æè¿°å°±æœ‰ç‚¹å•°å—¦äº†,ç„¶åå°±è·³è¿‡äº†,å¦‚æœä½ æ„Ÿè§‰åˆ°å…¶ä¸­å“ªäº›åœ°æ–¹è¿·ç³Š,å¯ä»¥ç»™æˆ‘å‘é‚®ä»¶</p>
</li>
</ol>
<h4 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h4><p>åŒºå—é“¾ç¨‹åºçŒ¿ä¸€æš<br><strong>email:<a href="mailto:skunny@163.com" target="_blank" rel="noopener">skunny@163.com</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/24/uniswap æºç è§£è¯»1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/24/uniswap æºç è§£è¯»1/" itemprop="url">ä¸€æ­¥ä¸€æ­¥æ•™ä½ æ‰“é€ è‡ªå·±çš„defi-xswap(1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-10-24T18:31:22+08:00">
                2020-10-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="welcome"><a href="#welcome" class="headerlink" title="welcome"></a>welcome</h4><blockquote>
<p><a href="https://etherscan.io/address/0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f#code" target="_blank" rel="noopener">uniswapåˆçº¦æºç  etherscan</a><br><a href="https://github.com/Uniswap/uniswap-v2-core" target="_blank" rel="noopener">uniswapåˆçº¦æºç  github</a><br>ç”±äºåœ¨å·¥ä½œä¸­å·²ç»åŸºäºuniswapå®ç°äº†æ›´å¤šç©æ³•çš„defi,åœ¨æ­¤æŠŠå…¶ä¸­çš„æµç¨‹å†æ¢³ç†ä¸€ä¸‹<br>æœ¬ç³»åˆ—æ–‡ç« ä»…ä½œä¸ºuniswapçš„æºç ç†è§£ä»¥åŠå¸¦ä½ å¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå·±çš„xswap,å…¶ä»–ç©æ³•è¯·å„ä½åŒå­¦è‡ªå·±å‘æŒ¥äº†</p>
</blockquote>
<h4 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h4><ol>
<li>ç¼–ç¨‹è¯­è¨€ <ul>
<li><strong>solidity</strong>(å†™ä»¥å¤ªåŠåˆçº¦çš„è¯­è¨€),</li>
<li><strong>nodejs</strong> (å¼€å‘ç¯å¢ƒ)</li>
<li><strong>react</strong>(å†™webå‰ç«¯)</li>
</ul>
</li>
<li>å·¥å…·<ul>
<li>metamask(ä»¥å¤ªåŠé’±åŒ…)</li>
<li>ä»¥å¤ªåŠè´¦å·,ç”±äºè®¡åˆ’åˆçº¦éƒ¨ç½²åœ¨rinkebyä¸Š,æ‰€ä»¥å¾—å»é¢†ä¸€äº›ether</li>
<li>æ¢¯å­,è¿™ä¸ªä½ æ‡‚çš„</li>
</ul>
</li>
</ol>
<h4 id="æ­å»ºä»¥å¤ªåŠå¼€å‘ç¯å¢ƒ"><a href="#æ­å»ºä»¥å¤ªåŠå¼€å‘ç¯å¢ƒ" class="headerlink" title="æ­å»ºä»¥å¤ªåŠå¼€å‘ç¯å¢ƒ"></a>æ­å»ºä»¥å¤ªåŠå¼€å‘ç¯å¢ƒ</h4><ol>
<li><a href="http://remix.ethereum.org/#optimize=false&amp;version=soljson-v0.5.1+commit.c8a2cb62.js" target="_blank" rel="noopener">remix</a>,</li>
<li><a href="https://www.trufflesuite.com/" target="_blank" rel="noopener">truffle</a>,</li>
<li><a href="https://getwaffle.io/" target="_blank" rel="noopener">waffle</a>,</li>
<li><a href="https://hardhat.org/" target="_blank" rel="noopener">Hardhat</a></li>
<li><a href="https://github.com/shaokun11/solidity-env-hardhat" target="_blank" rel="noopener">æ¼”ç¤ºç”¨çš„</a>  (ä¸»è¦æ˜¯å°†å®˜æ–¹demoæ”¹ä¸ºtsç‰ˆæœ¬)  </li>
</ol>
<blockquote>
<p> è‡³äºæ€ä¹ˆé€‰æ‹©,åˆé€‚è‡ªå·±çš„å°±æ˜¯æœ€å¥½çš„</p>
</blockquote>
<h4 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><p>æ­¤éƒ¨åˆ†ä»£ç ä¸ºdemoä»£ç ,å¦‚æœä½ å’Œæˆ‘é€‰ç”¨çš„æ˜¯åŒä¸€ä¸ªæ¡†æ¶,åº”è¯¥å’Œä¸‹é¢æ˜¯ä¸€æ ·çš„  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//SPDX-License-Identifier: Unlicense</span><br><span class="line">pragma solidity ^0.7.0;</span><br><span class="line"></span><br><span class="line">import &quot;hardhat/console.sol&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Greeter &#123;</span><br><span class="line">  string greeting;</span><br><span class="line"></span><br><span class="line">  constructor(string memory _greeting) &#123;</span><br><span class="line">    // è¿™é‡Œå¯ä»¥æ‰“å°console,æ‰€ä»¥é€‰æ‹©äº†è¿™ä¸ªæ¡†æ¶è¿›è¡Œå¼€å‘</span><br><span class="line">    console.log(&quot;Deploying a Greeter with greeting:&quot;, _greeting);</span><br><span class="line">    greeting = _greeting;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function greet() public view returns (string memory) &#123;</span><br><span class="line">    return greeting;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function setGreeting(string memory _greeting) public &#123;</span><br><span class="line">    console.log(&quot;Changing greeting from &apos;%s&apos; to &apos;%s&apos;&quot;, greeting, _greeting);</span><br><span class="line">    greeting = _greeting;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•è„šæœ¬</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;expect&#125; = <span class="built_in">require</span>(<span class="string">"chai"</span>);</span><br><span class="line"><span class="comment">//@ts-ignore</span></span><br><span class="line"><span class="keyword">import</span> &#123;ethers&#125; <span class="keyword">from</span> <span class="string">"hardhat"</span>;</span><br><span class="line"><span class="keyword">import</span> chai <span class="keyword">from</span> <span class="string">"chai"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Wallet&#125; <span class="keyword">from</span> <span class="string">"ethers"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;deployContract, solidity&#125; <span class="keyword">from</span> <span class="string">"ethereum-waffle"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Greeter"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">	it(<span class="string">"Should return the new greeting once it's changed"</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">const</span> Greeter = <span class="keyword">await</span> ethers.getContractFactory(<span class="string">"Greeter"</span>);</span><br><span class="line">		<span class="keyword">const</span> greeter = <span class="keyword">await</span> Greeter.deploy(<span class="string">"Hello, world!"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">await</span> greeter.deployed();</span><br><span class="line">		expect(<span class="keyword">await</span> greeter.greet()).to.equal(<span class="string">"Hello, world!"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">await</span> greeter.setGreeting(<span class="string">"Hola, mundo!"</span>);</span><br><span class="line">		expect(<span class="keyword">await</span> greeter.greet()).to.equal(<span class="string">"Hola, mundo!"</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="ç¯å¢ƒæ­å»ºç»“æœæ¼”ç¤º"><a href="#ç¯å¢ƒæ­å»ºç»“æœæ¼”ç¤º" class="headerlink" title="ç¯å¢ƒæ­å»ºç»“æœæ¼”ç¤º"></a>ç¯å¢ƒæ­å»ºç»“æœæ¼”ç¤º</h4><ol>
<li>æœ¬åœ°å¼€å‘å¯åŠ¨èŠ‚ç‚¹</li>
<li>ç¼–å†™æµ‹è¯•è„šæœ¬<br><img src="/xswap/ether1.gif" alt="demo"><h4 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h4>åŒºå—é“¾æŠ€æœ¯ç—´è¿·çš„ç¨‹åºçŒ¿ä¸€æš</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/16/koa+graphqlå®šä¹‰ä½ çš„æ¥å£/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/16/koa+graphqlå®šä¹‰ä½ çš„æ¥å£/" itemprop="url">koa + graphqlçš„ä½¿ç”¨</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-08-16T13:13:14+08:00">
                2020-08-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h4><blockquote>
<p>å®Œæˆhttpè¯·æ±‚åˆ°graphqlçš„è¯·æ±‚æ”¹é€ </p>
</blockquote>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><blockquote>
<p>å†…å®¹å¤§éƒ¨åˆ†æ¥è‡ªå·±graphqlä¸apollo-serverå®˜ç½‘, å†…éƒ¨åŠ ä¸Šè‡ªå·±çš„ä¸€äº›ç†è§£,è‡³äºæ”¹é€ å˜›,å°±è‡ªå·±åŠ¨æ‰‹å’¯</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; ApolloServer, gql &#125; = <span class="built_in">require</span>(<span class="string">"apollo-server-koa"</span>);</span><br><span class="line"><span class="keyword">const</span> GraphQLJSON = <span class="built_in">require</span>(<span class="string">"graphql-type-json"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; GraphQLScalarType &#125; = <span class="built_in">require</span>(<span class="string">"graphql"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; Kind &#125; = <span class="built_in">require</span>(<span class="string">"graphql/language"</span>);</span><br><span class="line"><span class="keyword">const</span> books = [</span><br><span class="line">  &#123;</span><br><span class="line">    title: <span class="string">"Harry Potter and the Chamber of Secrets"</span>,</span><br><span class="line">    author: <span class="string">"J.K. Rowling"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    title: <span class="string">"Jurassic Park"</span>,</span><br><span class="line">    author: <span class="string">"Michael Crichton"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> users = [</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">"1"</span>,</span><br><span class="line">    name: <span class="string">"Elizabeth Bennet"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    id: <span class="string">"2"</span>,</span><br><span class="line">    name: <span class="string">"Fitzwilliam Darcy"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> typeDefs = gql<span class="string">`</span></span><br><span class="line"><span class="string">  type Query &#123;</span></span><br><span class="line"><span class="string">    #   è¿”å›å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="string">    hello: String</span></span><br><span class="line"><span class="string">    # è¿”å›æ•°ç»„</span></span><br><span class="line"><span class="string">    books: [Book]</span></span><br><span class="line"><span class="string">    # é€šè¿‡å‚æ•°æŸ¥è¯¢</span></span><br><span class="line"><span class="string">    user(id: ID): User</span></span><br><span class="line"><span class="string">    info(date: Date): String</span></span><br><span class="line"><span class="string">    # è¯»å–æ•°æ®</span></span><br><span class="line"><span class="string">    foo: Foo</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  #ä½¿ç”¨ç¬¬ä¸‰æ–¹å®šä¹‰çš„æ ‡é‡ jsonç±»å‹</span></span><br><span class="line"><span class="string">  scalar JSON</span></span><br><span class="line"><span class="string">    # ä½¿ç”¨è‡ªå®šä¹‰çš„dateç±»å‹</span></span><br><span class="line"><span class="string">  scalar Date</span></span><br><span class="line"><span class="string">  type Foo &#123;</span></span><br><span class="line"><span class="string">    user: JSON</span></span><br><span class="line"><span class="string">    created: Date</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type Book &#123;</span></span><br><span class="line"><span class="string">    title: String</span></span><br><span class="line"><span class="string">    author: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  type User &#123;</span></span><br><span class="line"><span class="string">    id: ID</span></span><br><span class="line"><span class="string">    name: String</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolvers = &#123;</span><br><span class="line">  <span class="built_in">JSON</span>: GraphQLJSON, <span class="comment">// ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„jsonæ ‡é‡</span></span><br><span class="line">  <span class="built_in">Date</span>: <span class="keyword">new</span> GraphQLScalarType(&#123;</span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰æ ‡é‡</span></span><br><span class="line">    name: <span class="string">"Date"</span>,</span><br><span class="line">    description: <span class="string">"Date custom scalar type"</span>,</span><br><span class="line">    parseValue(value) &#123;</span><br><span class="line">      <span class="comment">// variables å‚æ•°è§£æè·¯å¾„</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(value);</span><br><span class="line">    &#125;,</span><br><span class="line">    serialize(value) &#123;</span><br><span class="line">      <span class="keyword">return</span> value.getTime();</span><br><span class="line">    &#125;,</span><br><span class="line">    parseLiteral(ast) &#123;</span><br><span class="line">      <span class="comment">// å­—é¢é‡å‚æ•°è·¯å¾„</span></span><br><span class="line">      <span class="keyword">if</span> (ast.kind === Kind.INT) &#123;</span><br><span class="line">        <span class="comment">// ast.value æ°¸è¿œæ˜¯ å­—ç¬¦ä¸²ç±»å‹ æ‰€ä»¥éœ€è¦è½¬æ¢</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(+ast.value);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  Query: &#123;</span><br><span class="line">    hello: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Hello shaokun!"</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    books: <span class="function"><span class="params">()</span> =&gt;</span> books, <span class="comment">// ç›´æ¥è¿”å›æ•°æ®åº“ä¸­çš„books</span></span><br><span class="line">    user(parent, args, context) &#123;</span><br><span class="line">      <span class="comment">// parent è¿ç»­æŸ¥è¯¢ ä¸­ ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœ</span></span><br><span class="line">      <span class="comment">// args æŸ¥è¯¢å‚æ•° å¦‚ä¸Šé¢çš„id</span></span><br><span class="line">      <span class="comment">// context å…¨å±€æ•°æ®çš„æ‹¿å–</span></span><br><span class="line">      <span class="built_in">console</span>.log(parent, args, context.name, context.age);</span><br><span class="line">      <span class="keyword">return</span> users.find(<span class="function">(<span class="params">user</span>) =&gt;</span> user.id === args.id);</span><br><span class="line">    &#125;,</span><br><span class="line">    foo: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        user: &#123; <span class="attr">name</span>: <span class="string">"shaokum"</span> &#125;,   <span class="comment">// å¦‚æœè¿”å›çš„ä¸æ˜¯jsonç±»å‹ åˆ™ä¸ºnull</span></span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>(),        <span class="comment">// Dateç±»å‹ å®é™…è¿”å›ç»™å‰ç«¯çš„æ˜¯ å®šä¹‰çš„scalarä¸­çš„serializeæ–¹æ³•</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    info: <span class="function">(<span class="params">_, args</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// æŸ¥è¯¢æ–¹å¼ å­—é¢å¸¸é‡æ–¹å¼æŸ¥è¯¢</span></span><br><span class="line">      <span class="comment">// &#123;</span></span><br><span class="line">      <span class="comment">//     info(data:1597552212000)</span></span><br><span class="line">      <span class="comment">// &#125;</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"---info-"</span>, args); <span class="comment">// é€šè¿‡Date.parseLiteral æ–¹æ³•æ‹¿åˆ°è§£æçš„æ•°æ®</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">"this date is "</span> + args.date.toString();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  typeDefs,</span><br><span class="line">  resolvers,</span><br><span class="line">  context: <span class="keyword">async</span> (request) =&gt; &#123;</span><br><span class="line">      <span class="comment">// å¯è·å–åˆ°rquestè¯·æ±‚</span></span><br><span class="line">    <span class="comment">// å¯ä»¥å…¨å±€æŒ‚è½½,å¦‚æˆæƒtoken dbå®ä¾‹</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="string">"shaokun"</span>,</span><br><span class="line">      age: <span class="number">18</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">server.applyMiddleware(&#123; app &#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: <span class="number">4000</span> &#125;, () =&gt;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`ğŸš€ Server ready at http://localhost:4000<span class="subst">$&#123;server.graphqlPath&#125;</span>`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h5 id="ç»“æœæ¼”ç¤º"><a href="#ç»“æœæ¼”ç¤º" class="headerlink" title="ç»“æœæ¼”ç¤º"></a>ç»“æœæ¼”ç¤º</h5><p><img src="/react/graphql.gif" alt="graphql query demo"> </p>
<h5 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h5><p>åŒºå—é“¾æŠ€æœ¯ç—´è¿·çš„ç¨‹åºçŒ¿ä¸€æšï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸Šå¾®ä¿¡å…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/02/åœ¨typescriptä¸­ä½¿ç”¨eosjs-ecc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/02/åœ¨typescriptä¸­ä½¿ç”¨eosjs-ecc/" itemprop="url">åœ¨typescriptä¸­ä½¿ç”¨eosjs-ecc</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-02-02T16:19:14+08:00">
                2020-02-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><ul>
<li>tså¼€å‘åç«¯é¡¹ç›®,è€ƒè™‘åˆ°ç»´æŠ¤çš„éœ€è¦,è¿˜æ˜¯éœ€è¦tsæ¥æ”¯æŒ.å…¶ä¸­æ¶‰åŠåˆ°çš„libéƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„types,ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–æ¯”å¦‚eosjs-ecc</li>
</ul>
<h4 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h4><ol>
<li>ç®€å•å¿«é€Ÿ,ä½†æ˜¯æ²¡æœ‰ä»»ä½•æç¤ºäº†,IDEåŸºæœ¬çš„æç¤ºéƒ½æ²¡æœ‰äº†,å¯¹äºç›´æ¥å°†.jsâ€”&gt;.tså¯ä»¥ä½¿ç”¨</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tsconfig.jsonä¸­å°†æ­¤å­—æ®µè®¾ä¸ºfalse</span></span><br><span class="line">  <span class="string">"noImplicitAny"</span>: <span class="literal">false</span>,</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>è‡ªå·±å†™ **d.ts,å–œæ¬¢çš„åŒå­¦å¯ä»¥å°è¯•ä¸€ä¸‹</li>
<li><p>å·¥å…·è‡ªåŠ¨ç”Ÿæˆ,æ¨èæ–¹å¼<br> -è¿™é‡Œä½¿ç”¨å¾®è½¯æä¾›çš„<a href="https://github.com/microsoft/dts-gen" target="_blank" rel="noopener">dts-gen</a>è¿›è¡Œç”Ÿæˆ,æ”¾åˆ°é¡¹ç›®çš„ä»»æ„ç›®å½•å³å¯,ä½†æ˜¯è¿˜æ˜¯æ— æ³•ä½¿ç”¨,è¿™æ—¶éœ€è¦åœ¨æœ€å¤–é¢åŒ…è£¹ä¸€å±‚ declare module â€˜eosjs-eccâ€™{}å³å¯,å¦‚æœä½¿ç”¨ts-nodeæ‰§è¡Œé¡¹ç›®,éœ€è¦åœ¨å¯¼å…¥çš„æ—¶å€™æ·»åŠ ts-ignore,ç›´æ¥ä½¿ç”¨tscç¼–è¯‘åˆ™å¯ä»¥ä¸ç”¨</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @ts-ignore</span></span><br><span class="line"><span class="keyword">import</span> ecc <span class="keyword">from</span> <span class="string">'eosjs-ecc'</span></span><br><span class="line">ecc.randomKey(<span class="number">0</span>).then(<span class="function">(<span class="params">privateKey:string</span>) =&gt;</span> &#123;</span><br><span class="line">   	<span class="built_in">console</span>.log(privateKey )</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¼˜åŒ–  </p>
<ul>
<li>ç»†å¿ƒçš„åŒå­¦å‘ç°,é‡Œé¢çš„ç±»å‹å…¨æ˜¯any,ä¸€ç‚¹ç”¨å¤„éƒ½æ²¡æœ‰å•Š?<br>ä½†æ˜¯è¿™æ ·å¯ä»¥æœ‰IDEçš„æç¤ºäº†,tså¯ä»¥æ­£å¸¸å†™ä»£ç äº†å‘¢  </li>
<li><p>ç”±äºä¸€ä¸ªlibæˆ‘ä»¬ä¸ä¼šå®Œå…¨ç”¨å®ƒçš„æ–¹æ³•,é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å»ä¿®æ”¹ä¸€ä¸‹æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„ç±»å‹å³å¯.æ¯”å¦‚randomKeyè¿™ä¸ªæ–¹æ³•,æˆ‘ä»¬å°†å®ƒçš„declareä¸­çš„æŒ‰ç…§å¦‚ä¸‹æ›´æ”¹å³å¯,å†æ¬¡è°ƒç”¨å°±è¾¾åˆ°äº†æ­£å¸¸ä½¿ç”¨libçš„ç›®çš„å•¦</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export function randomKey(cpuEntropyBits: number ): Promise&lt;string&gt;;</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">randomKey</span>(<span class="params">cpuEntropyBits?: number </span>): <span class="title">Promise</span>&lt;<span class="title">string</span>&gt;;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h4 id="ä¼˜åŒ–-2020-02-21-15-14-56"><a href="#ä¼˜åŒ–-2020-02-21-15-14-56" class="headerlink" title="ä¼˜åŒ–(2020-02-21 15:14:56)"></a>ä¼˜åŒ–(2020-02-21 15:14:56)</h4><ul>
<li>ä¸Šè¿°ç¬¬äºŒç‚¹ä¸­,ä½¿ç”¨ts-nodeéœ€è¦åŠ ä¸Šts-ignore,è€Œç›´æ¥ä½¿ç”¨tscç¼–è¯‘ä¸ºä»€ä¹ˆèƒ½è¿‡å‘¢?</li>
<li>åŸæ¥åœ¨tsconfig.jsonä¸­,æˆ‘ä½¿ç”¨includeå±æ€§å°†å…¶å£°æ˜æ–‡ä»¶åŒ…å«åˆ°ç¼–è¯‘ä¸­äº†,æ•…å¯ä½¿ç”¨.æŸ¥çœ‹ts-nodeæ–‡æ¡£,åªéœ€è¦åœ¨æ‰§è¡Œts-node åŠ ä¸Šâ€“filesé€‰é¡¹,è¿™æ ·å°†ä¼šåŠ è½½tcconfig.jsonçš„includeå±æ€§,è¿™æ ·å°±ç§»é™¤ts-ignoreè¿™ä¸ªé€‰é¡¹äº†</li>
</ul>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>  æœ€å¼€å§‹è‡ªå·±å†™*.d.ts,åç»­å‘ç°äº†å±…ç„¶è¿˜æœ‰dts-genè¿™æ ·çš„å·¥å…·.å›å¤´æƒ³æƒ³,åˆ©ç”¨è¿™äº›å·¥å…·,çœŸé¦™ ^0^,</p>
<h4 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h4><p>åŒºå—é“¾æŠ€æœ¯ç—´è¿·çš„ç¨‹åºçŒ¿ä¸€æšï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸Šå¾®ä¿¡å…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚<br>email: <a href="mailto:&#x73;&#x6b;&#x75;&#110;&#110;&#121;&#x40;&#x31;&#54;&#x33;&#x2e;&#x63;&#x6f;&#109;" target="_blank" rel="noopener">&#x73;&#x6b;&#x75;&#110;&#110;&#121;&#x40;&#x31;&#54;&#x33;&#x2e;&#x63;&#x6f;&#109;</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/07/electronå¼€å‘è®°å½•/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shaokun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hello shaokun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/07/electronå¼€å‘è®°å½•/" itemprop="url">create-react-app + electronå¼€å‘æ¡Œé¢ç‰ˆåº”ç”¨</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-09-07T19:26:50+08:00">
                2019-09-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h5><p>ä½¿ç”¨create-react-app æ¥é…ç½®electron å¹¶æ‰“åŒ…,å½“ç„¶ä¸æƒ³æŠ˜è…¾ç¯å¢ƒçš„å¯ä»¥ç›´æ¥ä½¿ç”¨<br><a href="https://github.com/electron-react-boilerplate/electron-react-boilerplate" target="_blank" rel="noopener">æ¨¡æ¿</a>æ¥æ­å»ºç¯å¢ƒå‘¢.æˆ‘é€‰æ‹©äº†æŠ˜è…¾,è¿™é‡Œè®°å½•å…¶ä¸­çš„å…³é”®ç‚¹</p>
<h4 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h4><ol>
<li>ä½¿ç”¨create-react-app åˆ›å»ºé¡¹ç›®</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app react-electron</span><br><span class="line">cd react-electron</span><br><span class="line">npm install electron electron-builder image-size url --save-dev</span><br><span class="line"><span class="comment">// electronåŸºç¡€åŒ…</span></span><br><span class="line"><span class="comment">// electron-builderæ‰“åŒ…å·¥å…·</span></span><br><span class="line"><span class="comment">// image-size æä¾›æ¡Œé¢å›¾æ ‡çš„lib</span></span><br><span class="line"><span class="comment">// url electronçš„æ–‡ä»¶è·¯å¾„éœ€è¦çš„ä¸œè¥¿</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>åœ¨publicé‡Œåˆ›å»ºelectron.jsæ–‡ä»¶(å¯ä»¥copyå®˜ç½‘çš„,ä¸‹é¢æ˜¯æˆ‘çš„æœ€ç»ˆç‰ˆæœ¬),ä¸€å®šè¦æ”¾åœ¨publicç›®å½•ä¸‹,å› ä¸ºcraä¼šæŠŠè¿™ä¸ªæ–‡ä»¶å¤¹çš„æ–‡ä»¶å¤åˆ¶åˆ°buildç›®å½•ä¸‹çš„å‘¢</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> electron = <span class="built_in">require</span>(<span class="string">'electron'</span>);</span><br><span class="line"><span class="keyword">const</span> platform = <span class="built_in">require</span>(<span class="string">'os'</span>).platform(); <span class="comment">// è·å–å¹³å°ï¼šhttps://nodejs.org/api/os.html#os_os_platform</span></span><br><span class="line"><span class="comment">// æ§åˆ¶appç”Ÿå‘½å‘¨æœŸ.</span></span><br><span class="line"><span class="keyword">const</span> app = electron.app;</span><br><span class="line"><span class="comment">// æµè§ˆå™¨çª—å£.</span></span><br><span class="line"><span class="keyword">const</span> BrowserWindow = electron.BrowserWindow;</span><br><span class="line"><span class="keyword">const</span> Menu = electron.Menu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">const</span> ipc = electron.ipcMain</span><br><span class="line"><span class="keyword">let</span> mainWindow;</span><br><span class="line"></span><br><span class="line">ipc.on(<span class="string">'app close window'</span>, (sys, msg) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(sys, msg)</span><br><span class="line">    mainWindow.close()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(platform);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> setupMenu = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> menu = <span class="keyword">new</span> Menu();</span><br><span class="line">    mainWindow.setMenu(menu);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> template = [&#123;</span><br><span class="line">        label: <span class="string">"Application"</span>,</span><br><span class="line">        submenu: [&#123;</span><br><span class="line">            label: <span class="string">"About Application"</span>,</span><br><span class="line">            selector: <span class="string">"orderFrontStandardAboutPanel:"</span></span><br><span class="line">        &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                type: <span class="string">"separator"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Quit"</span>,</span><br><span class="line">                accelerator: <span class="string">"Command+Q"</span>,</span><br><span class="line">                click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    quit();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        label: <span class="string">"Edit"</span>,</span><br><span class="line">        submenu: [&#123;</span><br><span class="line">            label: <span class="string">"Undo"</span>,</span><br><span class="line">            accelerator: <span class="string">"CmdOrCtrl+Z"</span>,</span><br><span class="line">            selector: <span class="string">"undo:"</span></span><br><span class="line">        &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Redo"</span>,</span><br><span class="line">                accelerator: <span class="string">"Shift+CmdOrCtrl+Z"</span>,</span><br><span class="line">                selector: <span class="string">"redo:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                type: <span class="string">"separator"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Cut"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+X"</span>,</span><br><span class="line">                selector: <span class="string">"cut:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Copy"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+C"</span>,</span><br><span class="line">                selector: <span class="string">"copy:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Paste"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+V"</span>,</span><br><span class="line">                selector: <span class="string">"paste:"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                label: <span class="string">"Select All"</span>,</span><br><span class="line">                accelerator: <span class="string">"CmdOrCtrl+A"</span>,</span><br><span class="line">                selector: <span class="string">"selectAll:"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    Menu.setApplicationMenu(Menu.buildFromTemplate(template));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWindow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæµè§ˆå™¨çª—å£.</span></span><br><span class="line">    mainWindow = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">        width: <span class="number">800</span>,</span><br><span class="line">        height: <span class="number">600</span>,</span><br><span class="line">        webPreferences: &#123;</span><br><span class="line">            nodeIntegration: <span class="literal">true</span>,  <span class="comment">//å…è®¸ä½¿ç”¨nodeçš„æ–¹å¼å¼•å…¥</span></span><br><span class="line">            webSecurity: <span class="literal">false</span>, <span class="comment">// å…è®¸ä½¿ç”¨æœ¬åœ°èµ„æº</span></span><br><span class="line">        &#125;,</span><br><span class="line">        backgroundColor: <span class="string">'#B1FF9D'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œæ˜¯è®©æµè§ˆå™¨çª—å£åŠ è½½ç½‘é¡µã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å¼€å‘ç¯å¢ƒï¼Œåˆ™urlä¸ºhttp://localhost:3000ï¼ˆpackage.jsonä¸­é…ç½®ï¼‰</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œåˆ™urlä¸ºbuild/index.html</span></span><br><span class="line">    <span class="keyword">const</span> startUrl = process.env.ELECTRON_START_URL || url.format(&#123;</span><br><span class="line">        pathname: path.join(__dirname, <span class="string">'/../build/index.html'</span>),</span><br><span class="line">        protocol: <span class="string">'file:'</span>,</span><br><span class="line">        slashes: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    setupMenu()</span><br><span class="line">    <span class="comment">// åŠ è½½ç½‘é¡µä¹‹åï¼Œä¼šåˆ›å»º`æ¸²æŸ“è¿›ç¨‹`</span></span><br><span class="line">    mainWindow.loadURL(startUrl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€chromeæµè§ˆå™¨å¼€å‘è€…å·¥å…·.</span></span><br><span class="line">    <span class="keyword">if</span> (startUrl.startsWith(<span class="string">'http'</span>)) &#123;</span><br><span class="line">        mainWindow.webContents.openDevTools();</span><br><span class="line">    &#125;</span><br><span class="line">    mainWindow.webContents.openDevTools();</span><br><span class="line">    mainWindow.on(<span class="string">'closed'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        mainWindow = <span class="literal">null</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'ready'</span>, createWindow);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'window-all-closed'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.platform !== <span class="string">'darwin'</span>) &#123;</span><br><span class="line">        app.quit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'activate'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mainWindow === <span class="literal">null</span>) &#123;</span><br><span class="line">        createWindow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>ä¿®æ”¹package.json  mainå­—æ®µä¿®æ”¹çš„æ˜¯ç¨‹åºçš„å…¥å£, buildä¸ºelectron-builderçš„æ‰“åŒ…çš„ä¸€äº›é…ç½®</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"main"</span>: <span class="string">"./public/electron.js"</span>,</span><br><span class="line"><span class="string">"homepage"</span>: <span class="string">"."</span>,</span><br><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"start"</span>: <span class="string">"react-scripts start"</span>,</span><br><span class="line">  <span class="string">"build"</span>: <span class="string">"react-scripts build"</span>,</span><br><span class="line">  <span class="string">"test"</span>: <span class="string">"react-scripts test"</span>,</span><br><span class="line">  <span class="string">"eject"</span>: <span class="string">"react-scripts eject"</span>,</span><br><span class="line">  <span class="string">"electron"</span>: <span class="string">"electron ."</span>,</span><br><span class="line">  <span class="string">"electron-dev"</span>: <span class="string">"ELECTRON_START_URL=http://localhost:3000/ electron ."</span>,</span><br><span class="line">  <span class="string">"packager"</span>: <span class="string">"npm run build &amp;&amp; rm -rf dist &amp;&amp; electron-builder --mac"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"build"</span>: &#123;</span><br><span class="line">  <span class="string">"productName"</span>: <span class="string">"example"</span>,</span><br><span class="line">  <span class="string">"appId"</span>: <span class="string">"com.example.server"</span>,</span><br><span class="line">  <span class="string">"files"</span>: [</span><br><span class="line">    <span class="string">"build/**/*"</span>,</span><br><span class="line">    <span class="string">"package.json"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"directories"</span>: &#123;</span><br><span class="line">    <span class="string">"buildResources"</span>: <span class="string">"public"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>npm start å¯åŠ¨reacté¡¹ç›®</li>
<li>npm run electron-dev å¯åŠ¨electroné¡¹ç›®  </li>
<li>npm run build æ‰“åŒ…reacté¡¹ç›®</li>
<li>npm run electron æŸ¥çœ‹reactæ‰“åŒ…çš„ç»“æœ</li>
<li>npm run package æ‰“åŒ…macåº”ç”¨(winéœ€è¦å†é…ç½®ä¸€ä¸‹)</li>
</ol>
<h5 id="ç»“æœæ¼”ç¤º"><a href="#ç»“æœæ¼”ç¤º" class="headerlink" title="ç»“æœæ¼”ç¤º"></a>ç»“æœæ¼”ç¤º</h5><p><a href="https://github.com/shaokun11/react-electron" target="_blank" rel="noopener">æºç </a><br><img src="/react/react-electron.gif" alt="material-ui self host font"> </p>
<h5 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h5><p>åŒºå—é“¾æŠ€æœ¯ç—´è¿·çš„ç¨‹åºçŒ¿ä¸€æšï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸Šå¾®ä¿¡å…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥ã€‚  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">shaokun</p>
              <p class="site-description motion-element" itemprop="description">è®°å½•è‡ªå·±å¯¹ç›¸å…³æŠ€æœ¯çš„ç‚¹ç‚¹æ»´æ»´å’Œä¸€äº›æ€è€ƒï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©æ¥åˆ°è¿™é‡Œçš„ä½ ï¼Œå¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åŠ ä¸ªå¾®ä¿¡å…±åŒæ¢è®¨</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shaokun</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
 <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> è®¿é—®äººæ•°
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> è®¿é—®æ€»é‡
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      æ¬¡
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
